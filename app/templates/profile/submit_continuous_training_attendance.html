{% import "bootstrap/wtf.html" as wtf %}

<div class="container-fluid">
    <form action="" method="post" enctype="multipart/form-data" id="continuous-training-attendance-form">
        {{ form.hidden_tag() }}
        <div class="mb-3">
            <label for="event-search-input" class="form-label">Rechercher un Événement de Formation Continue</label>
            <select class="form-control" id="event-search-input" name="event" required></select>
            <div class="form-text">Recherchez par titre, lieu, type ou date.</div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="event-type-filter" class="form-label">Filtrer par Type</label>
                <select class="form-control" id="event-type-filter">
                    <option value="">Tous les types</option>
                    {% for type_enum in ContinuousTrainingType %}
                        <option value="{{ type_enum.name }}">{{ type_enum.value }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="event-date-filter" class="form-label">Filtrer par Date</label>
                <input type="date" class="form-control" id="event-date-filter">
            </div>
        </div>
        {{ wtf.form_field(form.attendance_attachment) }}
    </form>
    <div class="mt-3">
        <p>L'événement n'est pas listé ?</p>
        <button type="button" class="btn btn-outline-primary action-btn" data-action-url="{{ url_for('profile.request_continuous_training_event') }}" data-modal-title="Demander un Événement de Formation Continue"><i class="fas fa-plus-circle"></i> Demander la Création d'un Événement</button>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Populate event type filter choices from the ContinuousTrainingType enum
        var eventTypeChoices = [
            { id: '', text: 'Tous les types' },
            {% for type_enum in ContinuousTrainingType %}
                { id: '{{ type_enum.name }}', text: '{{ type_enum.value }}' },
            {% endfor %}
        ];

        // Initialize Select2 for the event search input
        $('#event-search-input').select2({
            placeholder: 'Rechercher un événement...',
            allowClear: true,
            width: '100%',
            dropdownParent: $('#action-modal'), // Ensure dropdown is within the modal
            ajax: {
                url: '{{ url_for('profile.search_continuous_training_events') }}',
                dataType: 'json',
                delay: 250, // milliseconds
                data: function (params) {
                    return {
                        q: params.term, // search term
                        type: $('#event-type-filter').val(),
                        date: $('#event-date-filter').val()
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            },
            minimumInputLength: 0 // Allow empty search to show all results
        });

        // Re-initialize Select2 on the event type filter
        $('#event-type-filter').select2({
            placeholder: 'Filtrer par Type',
            allowClear: true,
            width: '100%',
            dropdownParent: $('#action-modal'),
            data: eventTypeChoices // Use the pre-defined choices
        });

        // Trigger search when filters change
        $('#event-type-filter, #event-date-filter').on('change', function() {
            $('#event-search-input').val(null).trigger('change'); // Clear current selection
            $('#event-search-input').select2('open'); // Re-open to show filtered results
        });
    });
</script>