{% extends "base.html" %}

{% block content %}
    <h1 class="mb-4">Mon Tableau de Bord Personnel</h1>

    <div class="row mb-4">
        <div class="col-md-8">
            <h2>{{ user.full_name }}</h2>
            <p class="text-muted"><a href="mailto:{{ user.email }}">{{ user.email }}</a></p>
            {% if user.study_level %}
                <p>Niveau d'étude : <strong>{{ user.study_level }}</strong></p>
            {% endif %}
            {% if user.id == current_user.id %} {# Only show API key to the owner of the profile #}
                <div class="mb-3">
                    <label for="api-key-display" class="form-label">Clé API:</label>
                    <div class="input-group">
                        <input type="text" id="api-key-display" class="form-control" value="{{ user.api_key or 'Non générée' }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="copy-api-key-btn" title="Copier la clé API">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn btn-warning" type="button" id="generate-api-key-btn" title="Générer une nouvelle Clé API">
                            <i class="fas fa-sync-alt"></i> Régénérer
                        </button>
                    </div>
                </div>
            {% endif %}
            {% if user.team %}
                <p>Équipe : <strong>{{ user.team.name }}</strong></p>
            {% endif %}
        </div>
        <div class="col-md-4 text-end">
            <div class="d-flex flex-column align-items-end">
                <!-- Actions Principales -->
                <button class="btn btn-primary mb-2 action-btn" data-action-url="{{ url_for('profile.submit_training_request') }}" data-modal-title="Demander une Formation" id="request-training-btn"><i class="fas fa-chalkboard-teacher"></i> Demander une Formation</button>
                <button class="btn btn-info mb-2 action-btn" data-action-url="{{ url_for('profile.declare_skill_practice') }}" data-modal-title="Déclarer une Pratique" id="declare-practice-btn"><i class="fas fa-running"></i> Déclarer une Pratique</button>
                <button class="btn btn-dark mb-2 action-btn" data-action-url="{{ url_for('profile.generate_user_booklet_pdf', user_id=user.id) }}" id="generate-booklet-btn"><i class="fas fa-file-pdf"></i> Livret PDF</button>

                <!-- New buttons for Initial Regulatory Training and Continuous Training Attendance -->
                {% if not initial_regulatory_training %}
                <button class="btn btn-success mb-2 action-btn" data-action-url="{{ url_for('profile.submit_initial_regulatory_training') }}" data-modal-title="Enregistrer Formation Initiale" id="submit-initial-reg-training-btn"><i class="fas fa-graduation-cap"></i> Enregistrer Formation Initiale</button>
                {% else %}
                <button class="btn btn-warning mb-2 action-btn" data-action-url="{{ url_for('profile.edit_initial_regulatory_training') }}" data-modal-title="Éditer Formation Initiale" id="edit-initial-reg-training-btn"><i class="fas fa-edit"></i> Éditer Formation Initiale</button>
                {% endif %}
                <button class="btn btn-primary mb-2 action-btn" data-action-url="{{ url_for('profile.submit_continuous_training_attendance') }}" data-modal-title="Déclarer Présence Formation Continue" id="submit-continuous-training-attendance-btn"><i class="fas fa-calendar-check"></i> Déclarer Présence FC</button>
                <button class="btn btn-secondary mb-2 action-btn" data-action-url="{{ url_for('profile.request_continuous_training_event') }}" data-modal-title="Demander un Événement de Formation Continue" id="request-continuous-training-event-btn"><i class="fas fa-calendar-plus"></i> Demander Événement FC</button>

                <!-- Actions Secondaires (Menu déroulant) -->
                <div class="btn-group mb-2">
                    <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-h"></i> Plus d'actions
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><button class="dropdown-item action-btn" data-action-url="{{ url_for('profile.submit_external_training') }}" data-modal-title="Soumettre une Formation Externe" id="submit-external-training-btn"><i class="fas fa-external-link-alt"></i> Soumettre Formation Externe</button></li>
                        <li><button class="dropdown-item action-btn" data-action-url="{{ url_for('profile.propose_skill') }}" data-modal-title="Proposer une Nouvelle Compétence" id="propose-skill-btn"><i class="fas fa-lightbulb"></i> Proposer une Compétence</button></li>
                        <li><a class="dropdown-item" href="{{ url_for('profile.edit_profile') }}"><i class="fas fa-user-edit"></i> Modifier le Profil</a></li>
                        <li><hr class="dropdown-divider"></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Initial Regulatory Training Section -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">Formation Réglementaire Initiale</div>
        <div class="card-body">
            {% if initial_regulatory_training %}
                <p><strong>Niveau:</strong> {{ initial_regulatory_training.level.value }}</p>
                <p><strong>Date de Formation:</strong> {{ initial_regulatory_training.training_date.strftime('%Y-%m-%d') }}</p>
                {% if initial_regulatory_training.attachment_path %}
                    <p><strong>Attestation:</strong> <a href="{{ url_for('static', filename=initial_regulatory_training.attachment_path) }}" target="_blank">Voir l'attestation</a></p>
                {% else %}
                    <p><strong>Attestation:</strong> Non fournie</p>
                {% endif %}
            {% else %}
                <p>Aucune formation réglementaire initiale enregistrée.</p>
            {% endif %}
        </div>
    </div>

    <!-- Continuous Training Summary -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">Formation Continue (Derniers {{ user.CONTINUOUS_TRAINING_YEARS_WINDOW }} ans)</div>
        <div class="card-body">
            <p><strong>Total Heures Validées:</strong> {{ "%.2f"|format(total_continuous_training_hours_6_years) }} / {{ "%.2f"|format(required_continuous_training_hours) }} heures requises</p>
            <p><strong>Heures en Présentiel:</strong> {{ "%.2f"|format(live_continuous_training_hours_6_years) }} heures</p>
            <p><strong>Heures en Ligne:</strong> {{ "%.2f"|format(online_continuous_training_hours_6_years) }} heures</p>
            <p><strong>Ratio Présentiel:</strong> {{ "%.2f"|format(live_training_ratio * 100) }}% (Recommandé: {{ "%.0f"|format(user.MIN_LIVE_TRAINING_RATIO * 100) }}%)</p>

            <p><strong>Statut de Conformité:</strong>
                {% if is_continuous_training_compliant %}
                    <span class="badge bg-success">Conforme</span>
                {% else %}
                    <span class="badge bg-danger">Non Conforme</span>
                {% endif %}
            </p>
            <p><strong>Conformité Ratio Présentiel:</strong>
                {% if is_live_training_ratio_compliant %}
                    <span class="badge bg-success">Conforme</span>
                {% else %}
                    <span class="badge bg-warning">Non Conforme (Moins de {{ "%.0f"|format(user.MIN_LIVE_TRAINING_RATIO * 100) }}% en présentiel)</span>
                {% endif %}
            </p>
            <p><strong>Risque pour l'année prochaine:</strong>
                {% if is_at_risk_next_year %}
                    <span class="badge bg-warning">À risque (Moins de 2.5 jours sur les 5 dernières années)</span>
                {% else %}
                    <span class="badge bg-info">Faible risque</span>
                {% endif %}
            </p>

            <h5 class="mt-4">Détail par Année:</h5>
            <ul class="list-group list-group-flush mb-3">
                {% for year, hours in continuous_training_summary_by_year.items() %}
                    <li class="list-group-item"><strong>{{ year }}:</strong> {{ "%.2f"|format(hours) }} heures</li>
                {% endfor %}
            </ul>

            <h5 class="mt-4">Formations Continues Validées:</h5>
            {% if continuous_trainings_attended %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th scope="col">Titre</th>
                                <th scope="col">Date</th>
                                <th scope="col">Type</th>
                                <th scope="col">Heures Validées</th>
                                <th scope="col">Attestation</th>
                                <th scope="col">Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ct in continuous_trainings_attended %}
                                {% set six_years_ago = datetime.utcnow() - timedelta(days=user.CONTINUOUS_TRAINING_YEARS_WINDOW * 365.25) %}
                                <tr class="{% if ct.event.event_date < six_years_ago %}table-secondary{% endif %}">
                                    <td>{{ ct.event.title }}</td>
                                    <td>{{ ct.event.event_date.strftime('%Y-%m-%d') }}
                                        {% if ct.event.event_date < six_years_ago %}
                                            <span class="badge bg-secondary ms-2">Archivé</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ ct.event.training_type.value }}</td>
                                    <td>{{ "%.2f"|format(ct.validated_hours) }}</td>
                                    <td>
                                        {% if ct.attendance_attachment_path %}
                                            <a href="{{ url_for('static', filename=ct.attendance_attachment_path) }}" target="_blank">Voir</a>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-success">{{ ct.status.value }}</span></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Aucune formation continue validée pour le moment.</p>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Compétences à acquérir -->
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-primary text-white">Compétences à Acquérir</div>
                <div class="card-body">
                    {% if required_skills_todo %}
                        <ul class="list-group list-group-flush">
                            {% for skill in required_skills_todo %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ skill.name }}
                                    <div>
                                        {% if skill.species %}
                                            {% for species in skill.species %}
                                                <span class="badge bg-secondary me-1">{{ species.name }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="badge bg-secondary me-1">N/A</span>
                                        {% endif %}
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Toutes les compétences requises sont acquises !</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Compétences à recycler -->
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-warning text-white">Compétences à Recycler</div>
                <div class="card-body">
                    {% set skills_to_recycle = [] %}
                    {% for comp in competencies %}
                        {% if comp.needs_recycling %}
                            {% set _ = skills_to_recycle.append(comp) %}
                        {% endif %}
                    {% endfor %}

                    {% if skills_to_recycle %}
                        <ul class="list-group list-group-flush">
                            {% for comp in skills_to_recycle %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ comp.skill.name }}
                                    <div>
                                        {% if comp.skill.species %}
                                            {% for species in comp.skill.species %}
                                                <span class="badge bg-secondary me-1">{{ species.name }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="badge bg-secondary me-1">N/A</span>
                                        {% endif %}
                                        <span class="badge bg-danger rounded-pill">Échéance: {{ comp.recycling_due_date.strftime('%Y-%m-%d') }}</span>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucune compétence ne nécessite de recyclage pour le moment.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Mes Compétences (Détail) -->
    <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">Mes Compétences</div>
        <div class="card-body">
            {% if competencies %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th scope="col">Compétence</th>
                                <th scope="col">Niveau</th>
                                <th scope="col">Évalué le</th>
                                <th scope="col">Évaluateur</th>
                                <th scope="col">Dernière Pratique</th>
                                <th scope="col">Échéance Recyclage</th>
                                <th scope="col">Validité</th>
                                <th scope="col">Espèces</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for comp in competencies %}
                                <tr class="{% if comp.needs_recycling %}table-danger{% elif comp.warning_date and datetime.utcnow() > comp.warning_date %}table-warning{% endif %}">
                                    <td>{{ comp.skill.name }}</td>
                                    <td>{{ comp.level }}</td>
                                    <td>{{ comp.evaluation_date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if comp.external_evaluator_name %}
                                            {{ comp.external_evaluator_name }}
                                        {% elif comp.evaluator %}
                                            {{ comp.evaluator.full_name }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>{{ comp.latest_practice_date.strftime('%Y-%m-%d') if comp.latest_practice_date else 'N/A' }}</td>
                                    <td>
                                        {% if comp.skill.validity_period_months %}
                                            {{ comp.recycling_due_date.strftime('%Y-%m-%d') }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if comp.skill.validity_period_months %}
                                            {% if comp.needs_recycling %}
                                                <span class="badge bg-danger">Expirée</span>
                                            {% elif comp.warning_date and datetime.utcnow() > comp.warning_date %}
                                                <span class="badge bg-warning">À Recycler Bientôt</span>
                                            {% else %}
                                                <span class="badge bg-success">Valide</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-info">Illimitée</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if comp.species %}
                                            {% for species in comp.species %}
                                                <span class="badge bg-secondary me-1">{{ species.name }}</span>
                                            {% endfor %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('profile.generate_certificate', competency_id=comp.id) }}" target="_blank" class="btn btn-sm btn-primary" title="Télécharger l'attestation"><i class="fas fa-download"></i></a>
                                        {% if comp.external_training_id %}
                                            <a href="{{ url_for('profile.show_external_training', training_id=comp.external_training_id) }}" target="_blank" class="btn btn-sm btn-info ms-1" title="Voir Formation Externe"><i class="fas fa-external-link-alt"></i></a>
                                        {% elif comp.training_session_id %}
                                            <a href="{{ url_for('admin.view_training_session_details', session_id=comp.training_session_id) }}" target="_blank" class="btn btn-sm btn-success ms-1" title="Voir Session de Formation"><i class="fas fa-chalkboard-teacher"></i></a>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Aucune compétence enregistrée pour le moment.</p>
            {% endif %}
        </div>
    </div>

    <!-- Demandes de Formation en Cours -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">Mes Demandes de Formation en Cours</div>
        <div class="card-body">
            {% if pending_training_requests_by_user %}
                <ul class="list-group list-group-flush">
                    {% for req in pending_training_requests_by_user %}
                        <li class="list-group-item d-flex justify-content-between align-items-center" id="training-request-{{ req.id }}">
                            Demande du {{ req.request_date.strftime('%Y-%m-%d') }} pour :
                            <div class="d-flex flex-wrap align-items-center">
                                {% for skill in req.skills_requested %}
                                    <span class="badge bg-info me-1 mb-1">{{ skill.name }}</span>
                                {% endfor %}
                                {% if req.species_requested %}
                                    {% for species in req.species_requested %}
                                        <span class="badge bg-secondary me-1 mb-1">{{ species.name }}</span>
                                    {% endfor %}
                                {% endif %}
                                {% if req.status == TrainingRequestStatus.PROPOSED_SKILL %}
                                    <span class="badge bg-warning me-1 mb-1">Compétence Proposée</span>
                                {% else %}
                                    <span class="badge bg-secondary me-1 mb-1">{{ req.status.value }}</span>
                                {% endif %}
                                <button class="btn btn-sm btn-danger delete-training-request-btn ms-2" data-request-id="{{ req.id }}" title="Supprimer la demande">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Aucune demande de formation en cours.</p>
            {% endif %}
        </div>
    </div>

    <!-- Sessions de Formation à Venir -->
    <div class="card shadow mb-4">
        <div class="card-header bg-info text-white">Mes Sessions de Formation à Venir</div>
        <div class="card-body">
            {% if upcoming_training_sessions_by_user %}
                <ul class="list-group list-group-flush">
                    {% for session in upcoming_training_sessions_by_user %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ session.title }} ({{ session.start_time.strftime('%Y-%m-%d %H:%M') }})
                            <span class="badge bg-primary">{{ session.location }}</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Aucune session de formation à venir.</p>
            {% endif %}
        </div>
    </div>

    <!-- Sessions de Formation Réalisées -->
    <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">Mes Sessions de Formation Réalisées</div>
        <div class="card-body">
            {% if completed_training_sessions_by_user %}
                <ul class="list-group list-group-flush">
                    {% for session in completed_training_sessions_by_user %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ session.title }} ({{ session.end_time.strftime('%Y-%m-%d') }})
                            <span class="badge bg-success">Terminée</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Aucune session de formation réalisée.</p>
            {% endif %}
        </div>
    </div>

    <!-- Modals for actions -->
    <div class="modal fade" id="action-modal" tabindex="-1" aria-labelledby="action-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="action-modal-label"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="submit-action-form-btn">Soumettre</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
{{ super() }}
<style>
    /* Ensure Select2 dropdowns appear above Bootstrap modals */
    .select2-container--open {
        z-index: 1060; /* Bootstrap modal has z-index 1050 */
    }
</style>
    
<script>
$(document).ready(function() {
    
    $(document).on('click', '.delete-training-request-btn', function() {
        
        var button = $(this);
                var requestId = button.data('request-id');
                var deleteUrl = "{{ url_for('profile.delete_training_request', request_id=0) }}".replace('0', requestId);
                var csrfToken = $('meta[name=csrf-token]').attr('content');

                if (confirm('Êtes-vous sûr de vouloir supprimer cette demande de formation ?')) {
                    fetch(deleteUrl, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            $('#training-request-' + requestId).remove();
                            alert(data.message);
                        } else {
                            alert('Erreur lors de la suppression : ' + (data.message || 'Erreur inconnue.'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Une erreur réseau est survenue.');
                    });
                }
            });
        });

    // Check if the modal element exists before initializing
    var actionModalElement = document.getElementById('action-modal');
    if (actionModalElement) {
        window.actionModal = new bootstrap.Modal(actionModalElement);

        // Destroy Select2 instances when the modal is hidden to prevent conflicts
        $('#action-modal').on('hide.bs.modal', function (e) {
            // When the modal is about to be hidden, check if the trigger was the close button
            if (document.activeElement === this.querySelector('.btn-close')) {
                // If so, blur it to prevent the accessibility error
                document.activeElement.blur();
            }

            $('.select2-hidden-accessible').each(function() {
                if ($(this).data('select2')) {
                    $(this).select2('destroy');
                }
            });

            // Return focus to the element that opened the modal
            if (activeElement) {
                activeElement.focus();
                activeElement = null; // Clear the stored element
            } else {
                // As a fallback, focus the body
                document.body.focus();
            }
        });
    }
    var currentFormActionUrl = '';
    var activeElement = null; // Variable to store the element that opened the modal

    $('.action-btn').on('click', function() {
        activeElement = this; // Store the clicked button
        var button = $(this);
        var actionUrl = button.data('action-url');
        var modalTitle = button.data('modal-title');
        
        // Special handling for PDF generation and API Key generation (no modal needed)
        if (button.attr('id') === 'generate-booklet-btn') {
            window.open(actionUrl, '_blank');
            return;
        }
        
        // For forms that need to be loaded into the modal
        currentFormActionUrl = actionUrl; // Store for form submission
        $('#action-modal-label').text(modalTitle);

        fetch(actionUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            $('#action-modal .modal-body').html(
                `<form id="modal-action-form" action="${actionUrl}" method="post" novalidate enctype="multipart/form-data">${html}</form>`
            );

            // --- START of logic for training request form ---
            if (actionUrl === "{{ url_for('profile.submit_training_request') }}") {
                // Initialize select2
                $('#species').select2({
                    placeholder: "Select a species",
                    allowClear: true,
                    dropdownParent: $('#action-modal'),
                    width: '100%'
                });
                $('#skills_requested').select2({
                    placeholder: "Select skills",
                    allowClear: true,
                    dropdownParent: $('#action-modal'),
                    width: '100%'
                });

                // Handle species selection change
                $('#species').on('change', function() {
                    var speciesId = $(this).val();
                    var skillsSelect = $('#skills_requested');
                    skillsSelect.empty();

                    if (speciesId) {
                        fetch(`/api/species/${speciesId}/skills`)
                            .then(response => response.json())
                            .then(data => {
                                data.forEach(skill => {
                                    var option = new Option(skill.name, skill.id, false, false);
                                    skillsSelect.append(option);
                                });
                                skillsSelect.trigger('change');
                            });
                    } else {
                        skillsSelect.trigger('change');
                    }
                });

                // Trigger change on page load if a species is already selected
                if ($('#species').val()) {
                    $('#species').trigger('change');
                }
            }
            // --- END of logic for training request form ---

            // --- START of logic for submit external training form ---
            if (actionUrl === "{{ url_for('profile.submit_external_training') }}") {
                const skillClaimsContainer = document.getElementById('skill-claims-container');
                const addSkillClaimButton = document.getElementById('add-skill-claim');
                let skillClaimCount = skillClaimsContainer.children.length;

                // Parse initial data
                const allSkills = JSON.parse(document.getElementById('all-skills-data').value);
                const allSpecies = JSON.parse(document.getElementById('all-species-data').value);
                const levelChoices = [
                    { value: 'Novice', label: 'Novice' },
                    { value: 'Intermediate', label: 'Intermediate' },
                    { value: 'Expert', label: 'Expert' }
                ];

                function generateOptions(data) {
                    return data.map(item => `<option value="${item.value}">${item.label}</option>`).join('');
                }

                function initializeSelect2ForEntry(entry) {
                    const $modalBody = $('#action-modal .modal-body');

                    $(entry).find('select').each(function () {
                        const $sel = $(this);
                        const placeholder = $sel.attr('placeholder') || '';

                        const opts = {
                            placeholder: placeholder,
                            allowClear: true,
                            width: '100%',
                            dropdownParent: $modalBody
                        };

                        if (!$sel.hasClass('level-select')) {
                            opts.minimumResultsForSearch = 0;
                        }

                        if ($sel.attr('id').includes('-skill')) {
                            opts.data = allSkills.map(s => ({ id: s.id, text: s.name }));
                        } else if ($sel.attr('id').includes('-species_claimed')) {
                            opts.data = allSpecies.map(s => ({ id: s.id, text: s.name }));
                        }

                        $sel.select2(opts);

                        if ($sel.hasClass('level-select')) {
                            $sel.on('change', function () {
                                toggleTutorCheckbox(this);
                            });
                            toggleTutorCheckbox($sel[0]);
                        }
                    });
                }

                function toggleTutorCheckbox(levelSelectElement) {
                    const level = levelSelectElement.value;
                    const skillClaimEntry = levelSelectElement.closest('.skill-claim-entry');
                    const tutorCheckbox = skillClaimEntry.querySelector('.tutor-checkbox');
                    const tutorLabel = skillClaimEntry.querySelector('label[for^="skill_claims-"][for$="-wants_to_be_tutor"]');

                    if (level === 'Intermediate' || level === 'Expert') {
                        tutorCheckbox.disabled = false;
                        tutorLabel.classList.remove('text-muted');
                    } else {
                        tutorCheckbox.checked = false;
                        tutorCheckbox.disabled = true;
                        tutorLabel.classList.add('text-muted');
                    }
                }

                function reindexSkillClaims() {
                    Array.from(skillClaimsContainer.children).forEach((entry, index) => {
                        entry.querySelector('.skill-claim-number').textContent = index + 1;
                        entry.querySelectorAll('[name^="skill_claims-"], [id^="skill_claims-"], [for^="skill_claims-"]').forEach(element => {
                            const nameAttr = element.getAttribute('name');
                            const idAttr = element.getAttribute('id');
                            const forAttr = element.getAttribute('for');
                            if (nameAttr) element.setAttribute('name', nameAttr.replace(/skill_claims-\d+/, `skill_claims-${index}`));
                            if (idAttr) element.setAttribute('id', idAttr.replace(/skill_claims-\d+/, `skill_claims-${index}`));
                            if (forAttr) element.setAttribute('for', forAttr.replace(/skill_claims-\d+/, `skill_claims-${index}`));
                        });
                    });
                }

                function updateRemoveButtons() {
                    const removeButtons = skillClaimsContainer.querySelectorAll('.remove-skill-claim');
                    const minEntries = 1; // Default to 1, as form object is not available here
                    const disable = skillClaimsContainer.children.length <= minEntries;
                    removeButtons.forEach(button => button.disabled = disable);
                }

                // Event listener for adding a new skill claim entry
                addSkillClaimButton.addEventListener('click', function() {
                    const index = skillClaimCount;
                    const newEntry = document.createElement('div');
                    newEntry.className = 'card mb-2 p-2 skill-claim-entry';
                    newEntry.innerHTML = `
                        <div class="card-header d-flex justify-content-between align-items-center p-1 bg-light">
                            <h6 class="mb-0">Skill Claim #${index + 1}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-skill-claim">Remove</button>
                        </div>
                        <div class="card-body p-2">
                            <div class="row g-2">
                                <div class="col-12">
                                    <select class="form-control form-control-sm" id="skill_claims-${index}-skill" name="skill_claims-${index}-skill" required
       placeholder="Select Skill">
                                        ${generateOptions(allSkills.map(s => ({value: s.id, label: s.name})))}
                                    </select>
                                </div>
                                <div class="col-md-3 mt-2">
                                    <select class="form-control form-control-sm species-select" id="skill_claims-${index}-species_claimed" name=
       "skill_claims-${index}-species_claimed" multiple="multiple" placeholder="Select Species">
                                        ${generateOptions(allSpecies.map(s => ({value: s.id, label: s.name})))}</select>
                                </div>
                                <div class="col-md-3 mt-2">
                                    <select class="form-control form-control-sm level-select" id="skill_claims-${index}-level" name="skill_claims-${index}-level"
       required placeholder="Level">
                                        ${generateOptions(levelChoices)}</select>
                                </div>
                                <div class="col-md-3 mt-2">
                                    <label class="form-label visually-hidden" for="skill_claims-${index}-practice_date">Date of Latest Practice</label>
                                    <input type="datetime-local" class="form-control form-control-sm" id="skill_claims-${index}-practice_date" name=
       "skill_claims-${index}-practice_date" placeholder="Last Practice Date">
                                </div>
                                <div class="col-md-3 mt-2 d-flex align-items-end">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input tutor-checkbox" id="skill_claims-${index}-wants_to_be_tutor" name=
       "skill_claims-${index}-wants_to_be_tutor" type="checkbox" value="y">
                                        <label class="form-check-label" for="skill_claims-${index}-wants_to_be_tutor">Tutor</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    skillClaimsContainer.appendChild(newEntry);
                    skillClaimCount++;
                    updateRemoveButtons();
                    initializeSelect2ForEntry(newEntry);
                    const newLevelSelect = newEntry.querySelector('.level-select');
                    newLevelSelect.addEventListener('change', () => toggleTutorCheckbox(newLevelSelect));
                    toggleTutorCheckbox(newLevelSelect);
                });

                // Event listener for removing a skill claim entry (using event delegation)
                skillClaimsContainer.addEventListener('click', function(event) {
                    if (event.target.classList.contains('remove-skill-claim')) {
                        const minEntries = 1;
                        if (skillClaimsContainer.children.length > minEntries) {
                            event.target.closest('.skill-claim-entry').remove();
                            skillClaimCount--;
                            reindexSkillClaims();
                            updateRemoveButtons();
                        } else {
                            alert('You must claim at least one skill.');
                        }
                    }
                });

                // Initial setup for existing form entries
                document.querySelectorAll('.skill-claim-entry').forEach(entry => {
                    initializeSelect2ForEntry(entry);
                    const levelSelect = entry.querySelector('.level-select');
                    if (levelSelect) { // Check if levelSelect exists
                        levelSelect.addEventListener('change', () => toggleTutorCheckbox(levelSelect));
                        toggleTutorCheckbox(levelSelect);
                    }
                });

                updateRemoveButtons();
            }
            // --- END of logic for submit external training form ---

            actionModal.show();
        })
        .catch(error => {
            console.error('Error loading form:', error);
            alert('Erreur lors du chargement du formulaire.');
        });
    });

        // Override the default form submission for this modal

    $('#submit-action-form-btn').on('click', function() {
        $('#modal-action-form').submit();
    });

    $('#action-modal').on('submit', '#modal-action-form', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var formData = new FormData(this);
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Action effectuée avec succès !');
                actionModal.hide();
                location.reload(); // Reload page to reflect changes
            } else {
                // Handle form errors (e.g., re-render form with errors)
                if (data.form_html) {
                    form.html(data.form_html); // Re-render form with errors
                } else {
                    alert(data.message || 'Erreur lors de l\'action.');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur réseau est survenue.');
        });
    });

    // Copy API Key to clipboard
    $('#copy-api-key-btn').on('click', function() {
        var apiKeyField = document.getElementById('api-key-display');
        apiKeyField.select();
        apiKeyField.setSelectionRange(0, 99999); // For mobile devices
        document.execCommand("copy");
        alert("Clé API copiée dans le presse-papiers !");
    });

    // Event listener for the new Generate API Key button
    $('#generate-api-key-btn').on('click', function() {
        var button = $(this);
        var actionUrl = "{{ url_for('profile.generate_api_key') }}"; // Directly use the URL

        if (confirm('Voulez-vous vraiment générer une nouvelle clé API ? L\'ancienne sera invalidée et la nouvelle ne sera affichée qu\'une seule fois.')) {
            fetch(actionUrl, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Nouvelle clé API générée avec succès ! Veuillez la noter : ' + data.api_key);
                    // Update the displayed API key
                    $('#api-key-display').val(data.api_key);
                    // Optionally, refresh the page or update a UI element
                    // location.reload(); // Reload to show new key flash message
                } else {
                    alert('Erreur lors de la génération de la clé API.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur réseau est survenue.');
            });
        }
    });
;
</script>
{% endblock %}