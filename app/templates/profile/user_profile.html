{% extends "base.html" %}

{% block content %}
    <h1 class="mb-4">Mon Tableau de Bord Personnel</h1>

    <div class="row mb-4">
        <div class="col-md-8">
            <h2>{{ user.full_name }}</h2>
            <p class="text-muted"><a href="mailto:{{ user.email }}">{{ user.email }}</a></p>
            {% if user.team %}
                <p>Équipe : <strong>{{ user.team.name }}</strong></p>
            {% endif %}
        </div>
        <div class="col-md-4 text-end">
            <div class="d-flex flex-column align-items-end">
                <!-- Actions Principales -->
                <button class="btn btn-primary mb-2 action-btn" data-action-url="{{ url_for('profile.submit_training_request') }}" data-modal-title="Demander une Formation" id="request-training-btn"><i class="fas fa-chalkboard-teacher"></i> Demander une Formation</button>
                <button class="btn btn-info mb-2 action-btn" data-action-url="{{ url_for('profile.declare_skill_practice') }}" data-modal-title="Déclarer une Pratique" id="declare-practice-btn"><i class="fas fa-running"></i> Déclarer une Pratique</button>
                <button class="btn btn-dark mb-2 action-btn" data-action-url="{{ url_for('profile.generate_user_booklet_pdf', user_id=user.id) }}" id="generate-booklet-btn"><i class="fas fa-file-pdf"></i> Livret PDF</button>

                <!-- Actions Secondaires (Menu déroulant) -->
                <div class="btn-group mb-2">
                    <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-h"></i> Plus d'actions
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><button class="dropdown-item action-btn" data-action-url="{{ url_for('profile.submit_external_training') }}" data-modal-title="Soumettre une Formation Externe" id="submit-external-training-btn"><i class="fas fa-external-link-alt"></i> Soumettre Formation Externe</button></li>
                        <li><button class="dropdown-item action-btn" data-action-url="{{ url_for('profile.propose_skill') }}" data-modal-title="Proposer une Nouvelle Compétence" id="propose-skill-btn"><i class="fas fa-lightbulb"></i> Proposer une Compétence</button></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><button class="dropdown-item action-btn" data-action-url="{{ url_for('profile.generate_api_key') }}" data-modal-title="Générer Clé API" id="generate-api-key-btn"><i class="fas fa-key"></i> Générer Clé API</button></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Compétences à acquérir -->
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-primary text-white">Compétences à Acquérir</div>
                <div class="card-body">
                    {% if required_skills_todo %}
                        <ul class="list-group list-group-flush">
                            {% for skill in required_skills_todo %}
                                <li class="list-group-item">{{ skill.name }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Toutes les compétences requises sont acquises !</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Compétences à recycler -->
        <div class="col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-warning text-white">Compétences à Recycler</div>
                <div class="card-body">
                    {% set skills_to_recycle = [] %}
                    {% for comp in competencies %}
                        {% if comp.needs_recycling %}
                            {% set _ = skills_to_recycle.append(comp) %}
                        {% endif %}
                    {% endfor %}

                    {% if skills_to_recycle %}
                        <ul class="list-group list-group-flush">
                            {% for comp in skills_to_recycle %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ comp.skill.name }}
                                    <span class="badge bg-danger rounded-pill">Échéance: {{ comp.recycling_due_date.strftime('%Y-%m-%d') }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucune compétence ne nécessite de recyclage pour le moment.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Mes Compétences (Détail) -->
    <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">Mes Compétences</div>
        <div class="card-body">
            {% if competencies %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th scope="col">Compétence</th>
                                <th scope="col">Niveau</th>
                                <th scope="col">Évalué le</th>
                                <th scope="col">Évaluateur</th>
                                <th scope="col">Dernière Pratique</th>
                                <th scope="col">Échéance Recyclage</th>
                                <th scope="col">Validité</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for comp in competencies %}
                                <tr class="{% if comp.needs_recycling %}table-danger{% elif comp.warning_date and datetime.utcnow() > comp.warning_date %}table-warning{% endif %}">
                                    <td>{{ comp.skill.name }}</td>
                                    <td>{{ comp.level }}</td>
                                    <td>{{ comp.evaluation_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ comp.evaluator.full_name if comp.evaluator else 'N/A' }}</td>
                                    <td>{{ comp.latest_practice_date.strftime('%Y-%m-%d') if comp.latest_practice_date else 'N/A' }}</td>
                                    <td>
                                        {% if comp.skill.validity_period_months %}
                                            {{ comp.recycling_due_date.strftime('%Y-%m-%d') }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if comp.skill.validity_period_months %}
                                            {% if comp.needs_recycling %}
                                                <span class="badge bg-danger">Expirée</span>
                                            {% elif comp.warning_date and datetime.utcnow() > comp.warning_date %}
                                                <span class="badge bg-warning">À Recycler Bientôt</span>
                                            {% else %}
                                                <span class="badge bg-success">Valide</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-info">Illimitée</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('profile.generate_certificate', competency_id=comp.id) }}" target="_blank" class="btn btn-sm btn-primary" title="Télécharger l'attestation"><i class="fas fa-download"></i></a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Aucune compétence enregistrée pour le moment.</p>
            {% endif %}
        </div>
    </div>

    <!-- Demandes de Formation en Cours -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">Mes Demandes de Formation en Cours</div>
        <div class="card-body">
            {% if pending_training_requests_by_user %}
                <ul class="list-group list-group-flush">
                    {% for req in pending_training_requests_by_user %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Demande du {{ req.request_date.strftime('%Y-%m-%d') }} pour :
                            <div>
                                {% for skill in req.skills_requested %}
                                    <span class="badge bg-info me-1">{{ skill.name }}</span>
                                {% endfor %}
                                {% if req.status == TrainingRequestStatus.PROPOSED_SKILL %}
                                    <span class="badge bg-warning">Compétence Proposée</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ req.status.value }}</span>
                                {% endif %}
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Aucune demande de formation en cours.</p>
            {% endif %}
        </div>
    </div>

    <!-- Sessions de Formation à Venir -->
    <div class="card shadow mb-4">
        <div class="card-header bg-info text-white">Mes Sessions de Formation à Venir</div>
        <div class="card-body">
            {% if upcoming_training_sessions_by_user %}
                <ul class="list-group list-group-flush">
                    {% for session in upcoming_training_sessions_by_user %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ session.title }} ({{ session.start_time.strftime('%Y-%m-%d %H:%M') }})
                            <span class="badge bg-primary">{{ session.location }}</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Aucune session de formation à venir.</p>
            {% endif %}
        </div>
    </div>

    <!-- Sessions de Formation Réalisées -->
    <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">Mes Sessions de Formation Réalisées</div>
        <div class="card-body">
            {% if completed_training_sessions_by_user %}
                <ul class="list-group list-group-flush">
                    {% for session in completed_training_sessions_by_user %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ session.title }} ({{ session.end_time.strftime('%Y-%m-%d') }})
                            <span class="badge bg-success">Terminée</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Aucune session de formation réalisée.</p>
            {% endif %}
        </div>
    </div>

    <!-- Modals for actions -->
    <div class="modal fade" id="action-modal" tabindex="-1" aria-labelledby="action-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="action-modal-label"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="submit-action-form-btn">Soumettre</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    var actionModal = new bootstrap.Modal(document.getElementById('action-modal'));
    var currentFormActionUrl = '';

    $('.action-btn').on('click', function() {
        var button = $(this);
        var actionUrl = button.data('action-url');
        var modalTitle = button.data('modal-title');
        
        // Special handling for PDF generation and API Key generation (no modal needed)
        if (button.attr('id') === 'generate-booklet-btn') {
            window.open(actionUrl, '_blank');
            return;
        }
        if (button.attr('id') === 'generate-api-key-btn') {
            if (confirm('Voulez-vous vraiment générer une nouvelle clé API ? L\'ancienne sera invalidée et la nouvelle ne sera affichée qu\'une seule fois.')) {
                fetch(actionUrl, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Nouvelle clé API générée avec succès ! Veuillez la noter : ' + data.api_key);
                        // Optionally, refresh the page or update a UI element
                        location.reload(); // Reload to show new key flash message
                    } else {
                        alert('Erreur lors de la génération de la clé API.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Une erreur réseau est survenue.');
                });
            }
            return;
        }

        // For forms that need to be loaded into the modal
        currentFormActionUrl = actionUrl; // Store for form submission
        $('#action-modal-label').text(modalTitle);

        fetch(actionUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            $('#action-modal .modal-body').html(
                `<form id="modal-action-form" action="${actionUrl}" method="post" novalidate enctype="multipart/form-data">${html}</form>`
            );
            actionModal.show();
        })
        .catch(error => {
            console.error('Error loading form:', error);
            alert('Erreur lors du chargement du formulaire.');
        });
    });

    // Handle form submission from the action modal
    $('#submit-action-form-btn').on('click', function() {
        $('#modal-action-form').submit();
    });

    $('#action-modal').on('submit', '#modal-action-form', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var formData = new FormData(this);
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Action effectuée avec succès !');
                actionModal.hide();
                location.reload(); // Reload page to reflect changes
            } else {
                // Handle form errors (e.g., re-render form with errors)
                if (data.form_html) {
                    form.html(data.form_html); // Re-render form with errors
                } else {
                    alert(data.message || 'Erreur lors de l\'action.');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur réseau est survenue.');
        });
    });
});
</script>
{% endblock %}
