{% extends "base.html" %}

{% block content %}
    {% for team_id, team_data in teams_competency_data.items() %}
    {% set team = team_data.team %}
    {% set team_members = team_data.members %}
    {% set competency_matrix = team_data.competency_matrix %}
    <h1 class="mb-4">Matrice des Compétences de l'Équipe {{ team.name }}</h1>
    <p>Vue d'overview des compétences et de leur statut pour les membres de votre équipe.</p>

    <div class="mb-3">
        <label for="competencyFilter-{{ team.id }}" class="form-label">Filter by:</label>
        <select class="form-select competency-filter" id="competencyFilter-{{ team.id }}" data-table-id="team-competencies-table-{{ team.id }}">
            <option value="">Montrer tous</option>
            <option value="ct-issue">Problème de Formation Continue</option>
            <option value="needs-recycling">Compétences à revoir</option>
        </select>
    </div>

    {% if team_members %}
        <div class="table-responsive">
            <table class="table table-bordered table-striped team-competencies-table" id="team-competencies-table-{{ team.id }}" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>Membre</th>
                        <th class="text-center">Status FC</th>
                        {% for skill in all_skills %}
                            <th class="text-center">
                                {{ skill.name }}<br>
                                {% for species in skill.species %}
                                    <span class="badge bg-info">{{ species.name }}</span>
                                {% endfor %}
                            </th>
                        {% endfor %}
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for member_id, data in competency_matrix.items() %}
                        {% set member = data.user %}
                        <tr>
                            <td>{{ member.full_name }}</td>
                            {% set summary = data.continuous_training_summary %}
                            <td class="text-center ct-status-cell" data-order="{{ summary.total_hours_6_years }}">
                                {% set color = 'success' %}
                                {% if not summary.is_compliant %}
                                    {% set color = 'danger' %}
                                {% elif not summary.is_live_ratio_compliant or summary.is_at_risk_next_year %}
                                    {% set color = 'warning' %}
                                {% endif %}
                                <span class="badge bg-{{ color }}" data-bs-toggle="tooltip" data-bs-placement="top" title="Total Hours: {{ '%.2f'|format(summary.total_hours_6_years) }} / {{ '%.2f'|format(summary.required_hours) }}. Live Ratio: {{ '%.0f'|format(summary.live_ratio * 100) }}%">
                                    <i class="fas fa-info-circle"></i>
                                </span>
                            </td>
                            {% for skill in all_skills %}
                                {% set skill_data = data.skills[skill.id] %}
                                <td class="text-center {% if skill_data.needs_recycling %}needs-recycling-cell{% endif %}">
                                    {% if skill_data.competency %}
                                        {% if skill_data.needs_recycling %}
                                            <span class="badge bg-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Recyclage dû: {{ skill_data.recycling_due_date.strftime('%Y-%m-%d') }}">
                                                {{ skill_data.competency.level }} (Recycle)
                                            </span>
                                        {% else %}
                                            <span class="badge bg-success" data-bs-toggle="tooltip" data-bs-placement="top" title="Dernière Pratique: {{ skill_data.latest_practice_date.strftime('%Y-%m-%d') if skill_data.latest_practice_date else 'N/A' }}">
                                                {{ skill_data.competency.level }}
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </td>
                            {% endfor %}
                            <td>
                                <a href="{{ url_for('dashboard.user_profile', username=member.full_name) }}" target="_blank" class="btn btn-sm btn-primary" title="Voir le profil"><i class="fas fa-user"></i></a>
                                <a href="{{ url_for('dashboard.generate_user_booklet_pdf', user_id=member.id) }}" target="_blank" class="btn btn-sm btn-secondary" title="Générer Livret PDF"><i class="fas fa-file-pdf"></i></a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>Votre équipe n'a actuellement aucun membre.</p>
    {% endif %}
    {% endfor %}

    <a href="{{ url_for('dashboard.user_profile', username=current_user.full_name) }}" class="btn btn-secondary mt-3">Retour au Dashboard</a>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    
        // Store tables in an object
        var dataTables = {};
    
        // Initialize each table
        document.querySelectorAll('.team-competencies-table').forEach(function(table) {
            var tableId = table.getAttribute('id');
            dataTables[tableId] = new DataTable(table, {
                responsive: true
            });
        });
    
        // Custom filter for DataTables
        $.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                var tableId = settings.sTableId;
                var filterValue = $('#competencyFilter-' + tableId.split('-').pop()).val();
    
                if (filterValue === '') {
                    return true; // Show all rows
                }
                
                var row = settings.aoData[dataIndex].nTr; // Get the row node
                if (filterValue === 'ct-issue') {
                    return $(row).find('.ct-status-cell .badge.bg-warning, .ct-status-cell .badge.bg-danger').length > 0;
                } else if (filterValue === 'needs-recycling') {
                    return $(row).find('.needs-recycling-cell').length > 0;
                }
                return true;
            }
        );
    
        // Attach event listener to all filter dropdowns
        document.querySelectorAll('.competency-filter').forEach(function(filter) {
            filter.addEventListener('change', function() {
                var tableId = this.getAttribute('data-table-id');
                dataTables[tableId].draw();
            });
        });
    });
    </script>
{% endblock %}
