{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block content %}
    <!-- Section: Cartes de Métriques Clés (Admin Specific) -->
    <div class="row">
        {% if current_user.can('training_request_manage') and pending_requests_count > 0 %}
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.list_training_requests') }}" class="card border-left-primary shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Formations en Attente</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_requests_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-inbox fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% endif %}

        {% if current_user.can('user_manage') and pending_user_approvals_count > 0 %}
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.pending_users') }}" class="card border-left-primary shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Utilisateurs en Attente d'Approbation</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_user_approvals_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% endif %}

        {% if current_user.can('skill_manage') and skills_without_tutors_count > 0 %}
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.tutor_less_skills_report') }}" class="card border-left-warning shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Compétences sans Tuteur</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ skills_without_tutors_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chalkboard-teacher fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% endif %}

        {% if current_user.can('view_reports') and recycling_needed_count > 0 %}
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.recycling_report') }}" class="card border-left-danger shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Recyclages Requis</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ recycling_needed_count }} utilisateurs</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-sync-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% endif %}

        {% if current_user.can('external_training_validate') and pending_external_trainings_count > 0 %}
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.validate_external_trainings') }}" class="card border-left-success shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Formations Externes à Valider</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_external_trainings_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% endif %}

        {% if current_user.can('training_session_manage') and next_session %}
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.manage_training_sessions') }}" class="card border-left-info shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Prochaine session</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ next_session.start_time.strftime('%Y-%m-%d %H:%M') }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% endif %}

        {% if current_user.can('training_session_manage') and sessions_to_be_finalized_count > 0 %}
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.manage_training_sessions', filter='to_be_finalized') }}" class="card border-left-warning shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Sessions à finaliser</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ sessions_to_be_finalized_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% endif %}

        {% if current_user.can('skill_manage') and proposed_skills_count > 0 %}
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.proposed_skills') }}" class="card border-left-info shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Compétences proposées</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ proposed_skills_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-lightbulb fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% endif %}

        {% if current_user.can('continuous_training_validate') and pending_continuous_training_validations_count > 0 %}
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.validate_continuous_trainings') }}" class="card border-left-danger shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Validations FC en Attente</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_continuous_training_validations_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% endif %}

        {% if current_user.can('continuous_training_manage') and pending_continuous_event_requests_count > 0 %}
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.manage_continuous_training_events') }}" class="card border-left-secondary shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">Demandes Événements FC en Attente</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_continuous_event_requests_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-plus fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Tabbed Interface for Management Sections -->
    <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
        {% if current_user.can('user_manage') %}
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-pane" type="button" role="tab" aria-controls="users-pane" aria-selected="true">Gestion des Utilisateurs</button>
        </li>
        {% endif %}
        {% if current_user.can('skill_manage') %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if not current_user.can('user_manage') %}active{% endif %}" id="skills-tab" data-bs-toggle="tab" data-bs-target="#skills-pane" type="button" role="tab" aria-controls="skills-pane" aria-selected="false">Gestion des Compétences</button>
        </li>
        {% endif %}
        {% if current_user.can('team_manage') %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if not current_user.can('user_manage') and not current_user.can('skill_manage') %}active{% endif %}" id="teams-tab" data-bs-toggle="tab" data-bs-target="#teams-pane" type="button" role="tab" aria-controls="teams-pane" aria-selected="false">Gestion des Équipes</button>
        </li>
        {% endif %}
        {% if current_user.can('continuous_training_manage') %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if not current_user.can('user_manage') and not current_user.can('skill_manage') and not current_user.can('team_manage') %}active{% endif %}" id="continuous-training-tab" data-bs-toggle="tab" data-bs-target="#continuous-training-pane" type="button" role="tab" aria-controls="continuous-training-pane" aria-selected="false">Gestion des Formations Continues</button>
        </li>
        {% endif %}
    </ul>
    <div class="tab-content" id="adminTabsContent">
        {% if current_user.can('user_manage') %}
        <div class="tab-pane fade show active" id="users-pane" role="tabpanel" aria-labelledby="users-tab">
            <!-- Section: Gestion des Utilisateurs -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Gestion des Utilisateurs</h6>
                    <div>
                        <button class="btn btn-success btn-sm me-2" data-bs-toggle="modal" data-bs-target="#import-users-modal">Importer</button>
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                Exporter
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('admin.export_users_xlsx') }}">Export Excel</a></li>
                            </ul>
                        </div>
                        <button class="btn btn-primary btn-sm" id="add-user-btn">Créer un utilisateur</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="users-table" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Nom complet</th>
                                    <th>Email</th>
                                    <th>Équipe</th>
                                    <th>Rôles</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr id="user-row-{{ user.id }}">
                                    <td>{{ user.full_name }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>
                                        {% for team in user.teams %}
                                            <span class="badge bg-secondary">{{ team.name }}</span>
                                        {% else %}
                                            Aucune
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {% if user.is_admin %}<span class="badge bg-primary">Admin</span>{% endif %}
                                        {% if user.teams_as_lead %}
                                            {% for team in user.teams_as_lead %}
                                                <span class="badge bg-info">Lead: {{ team.name }}</span>
                                            {% endfor %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('dashboard.dashboard_home', username=user.full_name) }}" target="_blank" class="btn btn-sm btn-info" title="Voir le livret"><i class="fa fa-eye"></i></a>
                                        <button class="btn btn-sm btn-warning edit-user-btn" data-edit-url="{{ url_for('admin.edit_user', id=user.id) }}" title="Éditer"><i class="fa fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger delete-user-btn" data-user-id="{{ user.id }}" data-delete-url="{{ url_for('admin.delete_user', id=user.id) }}" title="Supprimer"><i class="fa fa-trash"></i></button>
                                        <a href="{{ url_for('dashboard.generate_user_booklet_pdf', user_id=user.id) }}" target="_blank" class="btn btn-sm btn-secondary" title="Générer PDF"><i class="fa fa-file-pdf"></i></a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if current_user.can('skill_manage') %}
        <div class="tab-pane fade {% if not current_user.can('user_manage') %}show active{% endif %}" id="skills-pane" role="tabpanel" aria-labelledby="skills-tab">
            <!-- Section: Gestion des Compétences -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Gestion des Compétences</h6>
                    <div>
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#import-skills-modal">Importer</button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                Exporter
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('admin.export_skills_xlsx') }}">Export Excel</a></li>
                            </ul>
                        </div>
                        <button class="btn btn-primary btn-sm" id="add-skill-btn">Créer une compétence</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="skills-table" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th width="40%">Description</th>
                                    <th>Espèce(s)</th>
                                    <th>Tuteurs</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for skill in skills %}
                                <tr id="skill-row-{{ skill.id }}">
                                    <td>{{ skill.name }}</td>
                                    <td>{{ (skill.description or '')|truncate(120) }}</td>
                                    <td>
                                        {% for species in skill.species %}
                                            <span class="badge bg-secondary">{{ species.name }}</span>
                                        {% else %}
                                            Aucune
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {% for tutor in skill.tutors %}
                                            <span class="badge bg-dark">{{ tutor.full_name }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">Aucun</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-warning edit-skill-btn" data-edit-url="{{ url_for('admin.edit_skill', id=skill.id) }}" title="Éditer"><i class="fa fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger delete-skill-btn" data-skill-id="{{ skill.id }}" data-delete-url="{{ url_for('admin.delete_skill', id=skill.id) }}" title="Supprimer"><i class="fa fa-trash"></i></button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if current_user.can('team_manage') %}
        <div class="tab-pane fade {% if not current_user.can('user_manage') and not current_user.can('skill_manage') %}show active{% endif %}" id="teams-pane" role="tabpanel" aria-labelledby="teams-tab">
            <!-- Section: Gestion des Équipes -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Gestion des Équipes</h6>
                    <button class="btn btn-primary btn-sm" id="add-team-btn">Créer une équipe</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="teams-table" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Nb Members</th>
                                    <th>Team Leads</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for team in teams %}
                                <tr>
                                    <td>{{ team.name }}</td>
                                    <td>{{ team.members|length }}</td>
                                    <td>
                                        {% for lead in team.team_leads %}
                                            <a href="{{ url_for('dashboard.dashboard_home', username=lead.full_name) }}" class="badge bg-primary text-decoration-none">{{ lead.full_name }}</a>
                                        {% else %}
                                            Aucun
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('admin.edit_team', id=team.id) }}" class="btn btn-sm btn-warning" title="Éditer"><i class="fa fa-edit"></i></a>
                                        <button class="btn btn-sm btn-info add-user-to-team-btn" data-team-id="{{ team.id }}" data-team-name="{{ team.name }}" title="Add User to Team"><i class="fas fa-user-plus"></i></button>
                                        <form action="{{ url_for('admin.delete_team', id=team.id) }}" method="post" style="display:inline;">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-sm btn-danger" title="Supprimer"><i class="fa fa-trash"></i></button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if current_user.can('continuous_training_manage') %}
        <div class="tab-pane fade {% if not current_user.can('user_manage') and not current_user.can('skill_manage') and not current_user.can('team_manage') %}show active{% endif %}" id="continuous-training-pane" role="tabpanel" aria-labelledby="continuous-training-tab">
            <!-- Section: Gestion des Formations Continues -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Gestion des Événements de Formation Continue</h6>
                    <a href="{{ url_for('admin.add_continuous_training_event') }}" class="btn btn-primary btn-sm">Ajouter un Événement</a>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" id="continuous-training-search" class="form-control" placeholder="Search...">
                        </div>
                        <div class="col-md-4">
                            <select id="continuous-training-status-filter" class="form-select">
                                <option value="">All Statuses</option>
                                <option value="En attente">En attente</option>
                                <option value="Approuvé">Approuvé</option>
                                <option value="Rejeté">Rejeté</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered" id="continuous-training-events-table" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Titre</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Lieu</th>
                                    <th>Durée (h)</th>
                                    <th>Statut</th>
                                    <th>Participants Approuvés</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event, approved_attendees_count in all_continuous_events %}
                                <tr>
                                    <td>{{ event.title }}</td>
                                    <td>{{ event.training_type.value }}</td>
                                    <td>{{ event.event_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ event.location }}</td>
                                    <td>{{ event.duration_hours }}</td>
                                    <td>
                                        {% if event.status.name == 'PENDING' %}
                                            <span class="badge bg-warning">En Attente</span>
                                        {% elif event.status.name == 'APPROVED' %}
                                            <span class="badge bg-success">Approuvé</span>
                                        {% elif event.status.name == 'REJECTED' %}
                                            <span class="badge bg-danger">Rejeté</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="#" class="view-attendees-btn" data-bs-toggle="modal" data-bs-target="#attendeesModal" data-event-id="{{ event.id }}">
                                            {{ approved_attendees_count }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if event.status.name == 'PENDING' and current_user.can('continuous_training_validate') %}
                                            <a href="{{ url_for('admin.edit_continuous_training_event', event_id=event.id) }}" class="btn btn-sm btn-success" title="Valider l'événement"><i class="fas fa-check"></i></a>
                                        {% endif %}
                                        <a href="{{ url_for('admin.edit_continuous_training_event', event_id=event.id) }}" class="btn btn-sm btn-warning" title="Éditer"><i class="fa fa-edit"></i></a>
                                        <form action="{{ url_for('admin.delete_continuous_training_event', event_id=event.id) }}" method="post" style="display:inline;">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-sm btn-danger" title="Supprimer" onclick="return confirm("Êtes-vous sûr de vouloir supprimer cet événement ?");"><i class="fa fa-trash"></i></button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section: Validation des Formations Continues -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Validation des Formations Continues</h6>
                </div>
                <div class="card-body">
                    {% if pending_user_cts %}
                        <form action="{{ url_for('admin.batch_validate_continuous_trainings') }}" method="post">
                            {{ validation_form.hidden_tag() }}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="validation-table">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Training Event</th>
                                            <th>Event Date</th>
                                            <th>Attendance Certificate</th>
                                            <th>Validated Hours</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entry_form in validation_form.entries %}
                                            <tr>
                                                <td>{{ entry_form.user_full_name.data }}</td>
                                                <td>{{ entry_form.event_title.data }}</td>
                                                <td>{{ entry_form.event_date.data }}</td>
                                                <td>
                                                    {% if entry_form.attendance_attachment_path.data %}
                                                        <a href="{{ url_for('static', filename=entry_form.attendance_attachment_path.data) }}" target="_blank">View</a>
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {{ wtf.form_field(entry_form.validated_hours, form_type="inline") }}
                                                </td>
                                                <td>
                                                    {{ wtf.form_field(entry_form.status, form_type="inline") }}
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-success single-validate-btn" data-id="{{ entry_form.user_ct_id.data }}">Validate</button>
                                                    <button type="button" class="btn btn-sm btn-danger reject-ct-btn" data-id="{{ entry_form.user_ct_id.data }}">Reject</button>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {{ wtf.form_field(validation_form.submit_batch, class="btn btn-primary") }}
                        </form>
                    {% else %}
                        <p>No continuous trainings pending validation.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    var add_user_url = "{{ url_for('admin.add_user') }}";
    var import_export_users_url = "{{ url_for('admin.import_export_users') }}";
    var add_skill_url = "{{ url_for('admin.add_skill') }}";
    var import_export_skills_url = "{{ url_for('admin.import_export_skills') }}";
    var add_team_url = "{{ url_for('admin.add_team') }}";

    var addUsersToTeamModal = new bootstrap.Modal(document.getElementById('add-users-to-team-modal'));

    $('#user-edit-modal').on('hide.bs.modal', function () {
        $(this).removeAttr('aria-hidden');
        $(this).find(':focus').blur();
    });

    $('#skill-edit-modal').on('hide.bs.modal', function () {
        $(this).removeAttr('aria-hidden');
        $(this).find(':focus').blur();
    });

    $('#team-add-modal').on('hide.bs.modal', function () {
        $(this).removeAttr('aria-hidden');
        $(this).find(':focus').blur();
    });

    $('#add-users-to-team-modal').on('hide.bs.modal', function () {
        $(this).removeAttr('aria-hidden');
        $(this).find(':focus').blur();
    });

    $('#team-edit-modal').on('hide.bs.modal', function () {
        $(this).removeAttr('aria-hidden');
        $(this).find(':focus').blur(); // Ensure no element inside the modal retains focus
    });
</script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_management.js') }}"></script>
<script src="{{ url_for('static', filename='js/skill_management.js') }}"></script>
    <script src="{{ url_for('static', filename='js/team_management.js') }}"></script>
<script>
    $(document).ready(function() {
        if ($('#continuous-training-events-table').length) {
            var table = $('#continuous-training-events-table').DataTable();

            $('#continuous-training-search').on('keyup', function() {
                table.search(this.value).draw();
            });

            $('#continuous-training-status-filter').on('change', function() {
                var status = $(this).val();
                if (status) {
                    table.column(5).search('^' + status + '$', true, false).draw();
                } else {
                    table.column(5).search('').draw();
                }
            });
        }

        // Handle click on "Participants Approuvés" to show attendees modal
        $(document).on('click', '.view-attendees-btn', function(e) {
            e.preventDefault();
            var eventId = $(this).data('event-id');
            var attendeesModal = new bootstrap.Modal(document.getElementById('attendeesModal'));
            var modalBody = $('#attendeesModal .modal-body');
            var attendeesTableBody = $('#attendees-table tbody');

            attendeesTableBody.empty(); // Clear previous data

            // Show loading spinner inside the table body
            attendeesTableBody.html('<tr><td colspan="4" class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>');

            console.log('Fetching attendees for event ID:', eventId);
            fetch(`/admin/continuous_training_events/${eventId}/attendees`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received attendee data:', data);
                    attendeesTableBody.empty(); // Clear loading spinner and previous data
                    if (data.length > 0) {
                        data.forEach(attendee => {
                            console.log('Processing attendee:', attendee);
                            var row = `
                                <tr id="attendee-row-${attendee.id}">
                                    <td>${attendee.full_name}</td>
                                    <td>${attendee.email}</td>
                                    <td>${attendee.validated_hours}</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger remove-attendee-btn" data-event-id="${eventId}" data-user-id="${attendee.id}">Supprimer</button>
                                    </td>
                                </tr>
                            `;
                            attendeesTableBody.append(row);
                        });
                    } else {
                        console.log('No approved attendees found for this event.');
                        attendeesTableBody.append('<tr><td colspan="4">Aucun participant approuvé pour cet événement.</td></tr>');
                    }
                })
                .catch(error => {
                    console.error('Error fetching attendees:', error);
                    attendeesTableBody.html('<tr><td colspan="4" class="text-danger text-center">Erreur lors du chargement des participants.</td></tr>');
                });

            attendeesModal.show();
        });

        // Handle remove attendee button click
        $(document).on('click', '.remove-attendee-btn', function() {
            var button = $(this);
            var eventId = button.data('event-id');
            var userId = button.data('user-id');
            var csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            if (confirm('Êtes-vous sûr de vouloir supprimer ce participant ?')) {
                fetch(`/admin/continuous_training_events/${eventId}/remove_attendee/${userId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        $('#attendee-row-' + userId).remove(); // Remove row from table
                        // Optionally, update the count on the main dashboard table without full reload
                        // This would require finding the specific event row and decrementing its count
                        alert(data.message);
                        location.reload(); // For simplicity, reload the page to update counts
                    } else {
                        alert('Erreur lors de la suppression du participant: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error removing attendee:', error);
                    alert('Une erreur est survenue lors de la suppression du participant.');
                });
            }
        });

        document.querySelectorAll('.single-validate-btn').forEach(button => {
            button.addEventListener('click', function() {
                const userCtId = this.dataset.id;
                const row = this.closest('tr');
                const validatedHours = row.querySelector('input[name$="validated_hours"]').value;
                const status = 'APPROVED'; // NEW: Always send APPROVED for single validation
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

                fetch(`/admin/validate_continuous_trainings/single/${userCtId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken // Add CSRF token
                    },
                    body: JSON.stringify({
                        validated_hours: validatedHours,
                        status: status
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Erreur lors de la validation: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Une erreur est survenue lors de la validation.');
                });
            });
        });

        document.querySelectorAll('.reject-ct-btn').forEach(button => {
            button.addEventListener('click', function() {
                const userCtId = this.dataset.id;
                if (confirm('Êtes-vous sûr de vouloir rejeter cette formation continue ?')) {
                    fetch(`/admin/validate_continuous_trainings/reject/${userCtId}`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Erreur lors du rejet: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Une erreur est survenue lors du rejet.');
                    });
                }
            });
        });
    });
</script>
{% endblock %}
{% block modals %}
    <!-- Modal Placeholder for User Edit -->
    <div class="modal fade" id="user-edit-modal" tabindex="-1" aria-labelledby="user-edit-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="user-edit-modal-label">Éditer l'Utilisateur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- User form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="save-user-changes-btn">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for User Import -->
    <div class="modal fade" id="import-users-modal" tabindex="-1" aria-labelledby="import-users-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="import-users-modal-label">Importer des Utilisateurs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Import form will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Skill Edit -->
    <div class="modal fade" id="skill-edit-modal" tabindex="-1" aria-labelledby="skill-edit-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="skill-edit-modal-label">Éditer la Compétence</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Skill form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="save-skill-changes-btn">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Skill Import -->
    <div class="modal fade" id="import-skills-modal" tabindex="-1" aria-labelledby="import-skills-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="import-skills-modal-label">Importer des Compétences</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Import form will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Team Add -->
    <div class="modal fade" id="team-add-modal" tabindex="-1" aria-labelledby="team-add-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="team-add-modal-label">Créer une Équipe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Team form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="submit-team-form-btn">Créer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Add Users to Team -->
    <div class="modal fade" id="add-users-to-team-modal" tabindex="-1" aria-labelledby="add-users-to-team-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="add-users-to-team-modal-label">Add Users to Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Add Users to Team form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="submit-add-users-to-team-form-btn">Add Users</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Team Edit -->
    <div class="modal fade" id="team-edit-modal" tabindex="-1" aria-labelledby="team-edit-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="team-edit-modal-label">Éditer l'Équipe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Team edit form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="submit-team-edit-form-btn">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendees Modal -->
    <div class="modal fade" id="attendeesModal" tabindex="-1" aria-labelledby="attendeesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="attendeesModalLabel">Participants Approuvés</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="attendees-table" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Nom complet</th>
                                    <th>Email</th>
                                    <th>Heures Validées</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Attendee data will be loaded here via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}