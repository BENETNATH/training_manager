{% extends "base.html" %}

{% block content %}
    <h1 class="mb-4">Dashboard Administrateur</h1>

    <!-- Section 1: Cartes de Métriques Clés -->
    <div class="row">
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.list_training_requests') }}" class="card border-left-primary shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Formations en Attente</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_requests_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-inbox fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.tutor_less_skills_report') }}" class="card border-left-warning shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Compétences sans Tuteur</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ skills_without_tutors_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chalkboard-teacher fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2 clickable-card" data-target="#recycling-needed-section">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Recyclages Requis</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ recycling_needed_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-sync-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.validate_external_trainings') }}" class="card border-left-success shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Formations Externes à Valider</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_external_trainings_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.manage_training_sessions') }}" class="card border-left-info shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Prochaine session</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {% if next_session %}
                                    {{ next_session.start_time.strftime('%Y-%m-%d %H:%M') }}
                                {% else %}
                                    Aucune
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <!-- Section: Demandes de Formation en Attente -->
    <!-- This section is now moved to its own page: /admin/training_requests -->

    <!-- Section: Utilisateurs nécessitant un recyclage -->
    <div class="card shadow mb-4 d-none" id="recycling-needed-section">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Utilisateurs nécessitant un recyclage</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="recycling-needed-table" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Nom complet</th>
                            <th>Email</th>
                            <th>Équipe</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users_needing_recycling %}
                        <tr>
                            <td>{{ user.full_name }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.team.name if user.team else '' }}</td>
                            <td>
                                <a href="{{ url_for('profile.user_profile', user_id=user.id) }}" target="_blank" class="btn btn-sm btn-info" title="Voir le profil"><i class="fa fa-eye"></i></a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Gestion des Équipes</h6>
            <button class="btn btn-primary btn-sm" id="add-team-btn">Créer une équipe</button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="teams-table" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Nb Members</th>
                            <th>Team Leads</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for team in teams %}
                        <tr>
                            <td>{{ team.name }}</td>
                            <td>{{ team.members|length }}</td>
                            <td>
                                {% for lead in team.team_leads %}
                                    <a href="{{ url_for('profile.user_profile', user_id=lead.id) }}" class="badge bg-primary text-decoration-none">{{ lead.full_name }}</a>
                                {% else %}
                                    Aucun
                                {% endfor %}
                            </td>
                            <td>
                                <a href="{{ url_for('admin.edit_team', id=team.id) }}" class="btn btn-sm btn-warning" title="Éditer"><i class="fa fa-edit"></i></a>
                                <button class="btn btn-sm btn-info add-user-to-team-btn" data-team-id="{{ team.id }}" data-team-name="{{ team.name }}" title="Add User to Team"><i class="fas fa-user-plus"></i></button>
                                <form action="{{ url_for('admin.delete_team', id=team.id) }}" method="post" style="display:inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this team?');" title="Supprimer"><i class="fa fa-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Section 2: Tableau de Gestion des Utilisateurs -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Gestion des Utilisateurs</h6>
            <div>
                <button class="btn btn-success btn-sm me-2" data-bs-toggle="modal" data-bs-target="#import-users-modal">Importer</button>
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        Exporter
                    </button>
                    <ul class="dropdown-menu">

                        <li><a class="dropdown-item" href="{{ url_for('admin.export_users_xlsx') }}">Export Excel</a></li>
                    </ul>
                </div>
                <button class="btn btn-primary btn-sm" id="add-user-btn">Créer un utilisateur</button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="users-table" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Nom complet</th>
                            <th>Email</th>
                            <th>Équipe</th>
                            <th>Rôles</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr id="user-row-{{ user.id }}">
                            <td>{{ user.full_name }}</td>
                            <td>{{ user.email }}</td>
                            <td>
                                {% for team in user.teams %}
                                    <span class="badge bg-secondary">{{ team.name }}</span>
                                {% else %}
                                    Aucune
                                {% endfor %}
                            </td>
                            <td>
                                {% if user.is_admin %}<span class="badge bg-primary">Admin</span>{% endif %}
                                {% if user.teams_as_lead %}
                                    {% for team in user.teams_as_lead %}
                                        <span class="badge bg-info">Lead: {{ team.name }}</span>
                                    {% endfor %}
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('profile.user_profile', user_id=user.id) }}" target="_blank" class="btn btn-sm btn-info" title="Voir le livret"><i class="fa fa-eye"></i></a>
                                <button class="btn btn-sm btn-warning edit-user-btn" data-edit-url="{{ url_for('admin.edit_user', id=user.id) }}" title="Éditer"><i class="fa fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger delete-user-btn" data-user-id="{{ user.id }}" data-delete-url="{{ url_for('admin.delete_user', id=user.id) }}" title="Supprimer"><i class="fa fa-trash"></i></button>
                                <a href="{{ url_for('profile.generate_user_booklet_pdf', user_id=user.id) }}" target="_blank" class="btn btn-sm btn-secondary" title="Générer PDF"><i class="fa fa-file-pdf"></i></a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Section 3: Tableau de Gestion des Compétences -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Gestion des Compétences</h6>
            <div>
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#import-skills-modal">Importer</button>
                <div class="btn-group">
                    <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        Exporter
                    </button>
                    <ul class="dropdown-menu">

                        <li><a class="dropdown-item" href="{{ url_for('admin.export_skills_xlsx') }}">Export Excel</a></li>
                    </ul>
                </div>
                <button class="btn btn-primary btn-sm" id="add-skill-btn">Créer une compétence</button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="skills-table" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th width="40%">Description</th>
                            <th>Espèce(s)</th>
                            <th>Tuteurs</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for skill in skills %}
                        <tr id="skill-row-{{ skill.id }}">
                            <td>{{ skill.name }}</td>
                            <td>{{ (skill.description or '')|truncate(120) }}</td>
                            <td>
                                {% for species in skill.species %}
                                    <span class="badge bg-secondary">{{ species.name }}</span>
                                {% else %}
                                    Aucune
                                {% endfor %}
                            </td>
                            <td>
                                {% for tutor in skill.tutors %}
                                    <span class="badge bg-dark">{{ tutor.full_name }}</span>
                                {% else %}
                                    <span class="badge bg-warning">Aucun</span>
                                {% endfor %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-warning edit-skill-btn" data-edit-url="{{ url_for('admin.edit_skill', id=skill.id) }}" title="Éditer"><i class="fa fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger delete-skill-btn" data-skill-id="{{ skill.id }}" data-delete-url="{{ url_for('admin.delete_skill', id=skill.id) }}" title="Supprimer"><i class="fa fa-trash"></i></button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for User Edit -->
    <div class="modal fade" id="user-edit-modal" tabindex="-1" aria-labelledby="user-edit-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="user-edit-modal-label">Éditer l'Utilisateur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- User form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="save-user-changes-btn">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Skill Edit -->
    <div class="modal fade" id="skill-edit-modal" tabindex="-1" aria-labelledby="skill-edit-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="skill-edit-modal-label">Éditer la Compétence</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Skill form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="save-skill-changes-btn">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for User Import -->
    <div class="modal fade" id="import-users-modal" tabindex="-1" aria-labelledby="import-users-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="import-users-modal-label">Importer des Utilisateurs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Import form will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Skill Import -->
    <div class="modal fade" id="import-skills-modal" tabindex="-1" aria-labelledby="import-skills-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="import-skills-modal-label">Importer des Compétences</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Import form will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Team Add -->
    <div class="modal fade" id="team-add-modal" tabindex="-1" aria-labelledby="team-add-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="team-add-modal-label">Créer une Équipe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Team form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="submit-team-form-btn">Créer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Add Users to Team -->
    <div class="modal fade" id="add-users-to-team-modal" tabindex="-1" aria-labelledby="add-users-to-team-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="add-users-to-team-modal-label">Add Users to Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Add Users to Team form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="submit-add-users-to-team-form-btn">Add Users</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Team Edit -->
    <div class="modal fade" id="team-edit-modal" tabindex="-1" aria-labelledby="team-edit-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="team-edit-modal-label">Éditer l'Équipe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Team edit form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="submit-team-edit-form-btn">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
{{ super() }}
    <script>
$(document).ready(function() {
    var frenchLanguage = {
        "sEmptyTable":     "Aucune donnée disponible dans le tableau",
        "sInfo":           "Affichage de l'élément _START_ à _END_ sur _TOTAL_ éléments",
        "sInfoEmpty":      "Affichage de l'élément 0 à 0 sur 0 élément",
        "sInfoFiltered":   "(filtré de _MAX_ éléments au total)",
        "sInfoPostFix":    "",
        "sInfoThousands":  ",",
        "sLengthMenu":     "Afficher _MENU_ éléments",
        "sLoadingRecords": "Chargement...",
        "sProcessing":     "Traitement...",
        "sSearch":         "Rechercher :",
        "sZeroRecords":    "Aucun élément correspondant trouvé",
        "oPaginate": {
            "sFirst":    "Premier",
            "sLast":     "Dernier",
            "sNext":     "Suivant",
            "sPrevious": "Précédent"
        },
        "oAria": {
            "sSortAscending":  ": activer pour trier la colonne par ordre croissant",
            "sSortDescending": ": activer pour trier la colonne par ordre décroissant"
        }
    };

    $('#users-table').DataTable({
        language: frenchLanguage
    });
    $('#skills-table').DataTable({
        language: frenchLanguage
    });
    $('#teams-table').DataTable({
        language: frenchLanguage
    });

    // Handle AJAX deletion for users
    $('#users-table').on('click', '.delete-user-btn', function() {
        var button = $(this);
        var userId = button.data('user-id');
        var deleteUrl = button.data('delete-url');
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        if (confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ? Cette action est irréversible.')) {
            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#users-table').DataTable().row('#user-row-' + userId).remove().draw();
                } else {
                    alert('Erreur lors de la suppression : ' + (data.message || 'Erreur inconnue.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur réseau est survenue.');
            });
        }
    });

    // Handle modal opening for user edit
    var userEditModal = new bootstrap.Modal(document.getElementById('user-edit-modal'));
    var editingUserRow = null;

    $('#users-table').on('click', '.edit-user-btn', function() {
        var button = $(this);
        var editUrl = button.data('edit-url');
        editingUserRow = button.closest('tr'); // Save the row being edited
        
        $('#user-edit-modal-label').text('Éditer l\'Utilisateur');

        fetch(editUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            $('#user-edit-modal .modal-body').html(
                `<form id="modal-user-form" action="${editUrl}" method="post" novalidate>${html}</form>`
            );
            userEditModal.show();
        })
        .catch(error => {
            console.error('Error loading user form:', error);
            alert('Erreur lors du chargement du formulaire.');
        });
    });

    // Handle modal opening for user add
    $('#add-user-btn').on('click', function() {
        var addUrl = "{{ url_for('admin.add_user') }}";
        editingUserRow = null; // Ensure we are in 'add' mode

        $('#user-edit-modal-label').text('Créer un Utilisateur');

        fetch(addUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            $('#user-edit-modal .modal-body').html(
                `<form id="modal-user-form" action="${addUrl}" method="post" novalidate>${html}</form>`
            );
            userEditModal.show();
        })
        .catch(error => {
            console.error('Error loading user form:', error);
            alert('Erreur lors du chargement du formulaire.');
        });
    });

    // Handle form submission from the user modal (for both add and edit)
    $('#save-user-changes-btn').on('click', function() {
        $('#modal-user-form').submit();
    });

    var skillEditModal = new bootstrap.Modal(document.getElementById('skill-edit-modal'));
    var editingSkillRow = null; // Variable to hold the row being edited

    $('#user-edit-modal').on('submit', '#modal-user-form', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var formData = new FormData(this);
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var user = data.user;
                var rolesHtml = '';
                if (user.is_admin) rolesHtml += '<span class="badge bg-primary">Admin</span> ';
                if (user.is_team_lead) rolesHtml += '<span class="badge bg-secondary">Team Lead</span>';
                
                // Create the action buttons HTML
                var actionsHtml = 
                    `<a href="/profile/${user.id}" target="_blank" class="btn btn-sm btn-info" title="Voir le livret"><i class="fa fa-eye"></i></a> ` +
                    `<button class="btn btn-sm btn-warning edit-user-btn" data-edit-url="/admin/users/edit/${user.id}" title="Éditer"><i class="fa fa-edit"></i></button> ` +
                    `<button class="btn btn-sm btn-danger delete-user-btn" data-user-id="${user.id}" data-delete-url="/admin/users/delete/${user.id}" title="Supprimer"><i class="fa fa-trash"></i></button> ` +
                    `<a href="/profile/${user.id}/booklet.pdf" target="_blank" class="btn btn-sm btn-secondary" title="Générer PDF"><i class="fa fa-file-pdf"></i></a>`;

                var table = $('#users-table').DataTable();

                // Reconstruct teamsHtml
                var teamsHtml = '';
                if (user.teams && user.teams.length > 0) {
                    user.teams.forEach(function(teamName) {
                        teamsHtml += `<span class="badge bg-secondary">${teamName}</span> `;
                    });
                } else {
                    teamsHtml = 'Aucune';
                }

                // Reconstruct rolesHtml
                var rolesHtml = '';
                if (user.is_admin) rolesHtml += '<span class="badge bg-primary">Admin</span> ';
                if (user.teams_as_lead && user.teams_as_lead.length > 0) {
                    user.teams_as_lead.forEach(function(teamName) {
                        rolesHtml += `<span class="badge bg-info">Lead: ${teamName}</span> `;
                    });
                }
                
                // Create the action buttons HTML
                var actionsHtml = 
                    `<a href="/profile/${user.id}" target="_blank" class="btn btn-sm btn-info" title="Voir le livret"><i class="fa fa-eye"></i></a> ` +
                    `<button class="btn btn-sm btn-warning edit-user-btn" data-edit-url="/admin/users/edit/${user.id}" title="Éditer"><i class="fa fa-edit"></i></button> ` +
                    `<button class="btn btn-sm btn-danger delete-user-btn" data-user-id="${user.id}" data-delete-url="/admin/users/delete/${user.id}" title="Supprimer"><i class="fa fa-trash"></i></button> ` +
                    `<a href="/profile/${user.id}/booklet.pdf" target="_blank" class="btn btn-sm btn-secondary" title="Générer PDF"><i class="fa fa-file-pdf"></i></a>`;

                if (editingUserRow) {
                    // Update existing row
                    table.row(editingUserRow).data([
                        user.full_name,
                        user.email,
                        teamsHtml,
                        rolesHtml,
                        actionsHtml
                    ]).draw();
                } else {
                    // Add new row
                    table.row.add([
                        user.full_name,
                        user.email,
                        teamsHtml,
                        rolesHtml,
                        actionsHtml
                    ]).draw();
                }

                userEditModal.hide();
            } else {
                // Handle form errors (e.g., re-render form with errors)
                if (data.form_html) {
                    form.html(data.form_html); // Re-render form with errors
                } else {
                    alert(data.message || 'Erreur lors de la sauvegarde de l\'utilisateur.');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur réseau est survenue.');
        });
    });

    // Handle modal opening for skill edit
    $('#skills-table').on('click', '.edit-skill-btn', function() {
        var button = $(this);
        var editUrl = button.data('edit-url');
        editingSkillRow = button.closest('tr'); // Save the row being edited
        
        $('#skill-edit-modal-label').text('Éditer la Compétence');

        fetch(editUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            $('#skill-edit-modal .modal-body').html(
                `<form id="modal-skill-form" action="${editUrl}" method="post" novalidate>${html}</form>`
            );
            skillEditModal.show();
        })
        .catch(error => {
            console.error('Error loading skill form:', error);
            alert('Erreur lors du chargement du formulaire.');
        });
    });

    // Handle modal opening for skill add
    $('#add-skill-btn').on('click', function() {
        var addUrl = "{{ url_for('admin.add_skill') }}";
        editingSkillRow = null; // Ensure we are in 'add' mode

        $('#skill-edit-modal-label').text('Créer une Compétence');

        fetch(addUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            $('#skill-edit-modal .modal-body').html(
                `<form id="modal-skill-form" action="${addUrl}" method="post" novalidate>${html}</form>`
            );
            skillEditModal.show();
        })
        .catch(error => {
            console.error('Error loading skill form:', error);
            alert('Erreur lors du chargement du formulaire.');
        });
    });

    // Handle form submission from the skill modal (for both add and edit)
    $('#save-skill-changes-btn').on('click', function() {
        $('#modal-skill-form').submit();
    });

    // Handle AJAX deletion for skills
    $('#skills-table').on('click', '.delete-skill-btn', function() {
        var button = $(this);
        var skillId = button.data('skill-id');
        var deleteUrl = button.data('delete-url');
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        if (confirm('Êtes-vous sûr de vouloir supprimer cette compétence ? Cette action est irréversible.')) {
            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#skills-table').DataTable().row('#skill-row-' + skillId).remove().draw();
                } else {
                    alert('Erreur lors de la suppression : ' + (data.message || 'Erreur inconnue.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur réseau est survenue.');
            });
        }
    });

    $('#skill-edit-modal').on('submit', '#modal-skill-form', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var formData = new FormData(this);
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var skill = data.skill;
                var table = $('#skills-table').DataTable();

                // Reconstruct speciesHtml
                var speciesHtml = '';
                if (skill.species && skill.species.length > 0) {
                    skill.species.forEach(function(speciesName) {
                        speciesHtml += `<span class="badge bg-secondary">${speciesName}</span> `;
                    });
                } else {
                    speciesHtml = 'Aucune';
                }

                // Reconstruct tutorsHtml
                var tutorsHtml = '';
                if (skill.tutors && skill.tutors.length > 0) {
                    skill.tutors.forEach(function(tutorName) {
                        tutorsHtml += `<span class="badge bg-dark">${tutorName}</span> `;
                    });
                } else {
                    tutorsHtml = '<span class="badge bg-warning">Aucun</span>';
                }

                // Create the action buttons HTML
                var actionsHtml =
                    `<button class="btn btn-sm btn-warning edit-skill-btn" data-edit-url="/admin/skills/edit/${skill.id}" title="Éditer"><i class="fa fa-edit"></i></button> ` +
                    `<button class="btn btn-sm btn-danger delete-skill-btn" data-skill-id="${skill.id}" data-delete-url="/admin/skills/delete/${skill.id}" title="Supprimer"><i class="fa fa-trash"></i></button>`;

                if (editingSkillRow) {
                    // Update existing row
                    table.row(editingSkillRow).data([
                        skill.name,
                        skill.description,
                        speciesHtml,
                        tutorsHtml,
                        actionsHtml
                    ]).draw();
                } else {
                    // Add new row
                    table.row.add([
                        skill.name,
                        skill.description,
                        speciesHtml,
                        tutorsHtml,
                        actionsHtml
                    ]).draw();
                }

                skillEditModal.hide();
            } else {
                // Handle form errors (e.g., re-render form with errors)
                if (data.form_html) {
                    form.html(data.form_html); // Re-render form with errors
                } else {
                    alert(data.message || 'Erreur lors de la sauvegarde de la compétence.');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur réseau est survenue.');
        });
    });

    // Handle modal opening for user import
    $('#import-users-modal').on('show.bs.modal', function (event) {
        var modal = $(this);
        var importUrl = "{{ url_for('admin.import_export_users') }}";

        fetch(importUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            modal.find('.modal-body').html(html);
        })
        .catch(error => {
            console.error('Error loading import form:', error);
            alert('Erreur lors du chargement du formulaire d\'importation.');
        });
    });

    // Handle modal opening for skill import
    $('#import-skills-modal').on('show.bs.modal', function (event) {
        var modal = $(this);
        var importUrl = "{{ url_for('admin.import_export_skills') }}";

        fetch(importUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            modal.find('.modal-body').html(html);
        })
        .catch(error => {
            console.error('Error loading import form:', error);
            alert('Erreur lors du chargement du formulaire d\'importation de compétences.');
        });
    });

    // Handle modal opening for team add
    var teamAddModal = new bootstrap.Modal(document.getElementById('team-add-modal'));
    $('#add-team-btn').on('click', function() {
        var addUrl = "{{ url_for('admin.add_team') }}";

        $('#team-add-modal-label').text('Créer une Équipe');

        fetch(addUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            $('#team-add-modal .modal-body').html(
                `<form id="modal-team-form" action="${addUrl}" method="post" novalidate>${html}</form>`
            );
            teamAddModal.show();
        })
        .catch(error => {
            console.error('Error loading team form:', error);
            alert('Erreur lors du chargement du formulaire d\'équipe.');
        });
    });

    // Handle form submission from the team add modal
    $('#submit-team-form-btn').on('click', function() {
        $('#modal-team-form').submit();
    });

    $('#team-add-modal').on('submit', '#modal-team-form', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var formData = new FormData(this);
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Équipe créée avec succès !');
                teamAddModal.hide();
                location.reload(); // Reload page to reflect changes
            } else {
                if (data.form_html) {
                    form.html(data.form_html); // Re-render form with errors
                } else {
                    alert(data.message || 'Erreur lors de la création de l\'équipe.');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur réseau est survenue.');
        });
    });

    // Handle modal opening for team edit
    var teamEditModal = new bootstrap.Modal(document.getElementById('team-edit-modal'));
    $('#teams-table').on('click', '.edit-team-btn', function() {
        var button = $(this);
        var editUrl = button.attr('href'); // Get the URL from the href attribute

        $('#team-edit-modal-label').text('Éditer l\'Équipe');

        fetch(editUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            $('#team-edit-modal .modal-body').html(
                `<form id="modal-team-edit-form" action="${editUrl}" method="post" novalidate>${html}</form>`
            );
            teamEditModal.show();
        })
        .catch(error => {
            console.error('Error loading team edit form:', error);
            alert('Erreur lors du chargement du formulaire d\'édition d\'équipe.');
        });
    });

    // Handle form submission from the team edit modal
    $('#submit-team-edit-form-btn').on('click', function() {
        $('#modal-team-edit-form').submit();
    });

    $('#team-edit-modal').on('submit', '#modal-team-edit-form', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var formData = new FormData(this);
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Équipe mise à jour avec succès !');
                teamEditModal.hide();
                location.reload(); // Reload page to reflect changes
            } else {
                if (data.form_html) {
                    form.html(data.form_html); // Re-render form with errors
                } else {
                    alert(data.message || 'Erreur lors de la mise à jour de l\'équipe.');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur réseau est survenue.');
        });
    });

    // Handle AJAX deletion for teams
    $('#teams-table').on('submit', 'form', function(e) {
        e.preventDefault();
        var form = $(this);
        var deleteUrl = form.attr('action');
        var csrfToken = form.find('input[name=csrf_token]').val();

        if (confirm('Êtes-vous sûr de vouloir supprimer cette équipe ? Cette action est irréversible.')) {
            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message || 'Équipe supprimée avec succès !');
                    location.reload(); // Reload page to reflect changes
                } else {
                    alert('Erreur lors de la suppression : ' + (data.message || 'Erreur inconnue.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur réseau est survenue.');
            });
        }
    });

    // Handle modal opening for adding users to team
    var addUsersToTeamModal = new bootstrap.Modal(document.getElementById('add-users-to-team-modal'));
    $('#teams-table').on('click', '.add-user-to-team-btn', function() {
        var button = $(this);
        var teamId = button.data('team-id');
        var teamName = button.data('team-name');
        var addUsersUrl = "/admin/team/" + teamId + "/add_users";

        $('#add-users-to-team-modal-label').text('Add Users to ' + teamName);

        fetch(addUsersUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            $('#add-users-to-team-modal .modal-body').html(html);
            addUsersToTeamModal.show();
        })
        .catch(error => {
            console.error('Error loading add users to team form:', error);
            alert('Erreur lors du chargement du formulaire d\'ajout d\'utilisateurs à l\'équipe.');
        });
    });

    // Handle form submission from the add users to team modal
    $('#submit-add-users-to-team-form-btn').on('click', function() {
        $('#add-users-to-team-form').submit();
    });

    $('#add-users-to-team-modal').on('submit', '#add-users-to-team-form', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var formData = new FormData(this);
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Utilisateurs ajoutés à l\'équipe avec succès !');
                addUsersToTeamModal.hide();
                location.reload(); // Reload page to reflect changes
            } else {
                if (data.form_html) {
                    form.html(data.form_html); // Re-render form with errors
                } else {
                    alert(data.message || 'Erreur lors de l\'ajout d\'utilisateurs à l\'équipe.');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur réseau est survenue.');
        });
    });
});
</script>
{% endblock %}
