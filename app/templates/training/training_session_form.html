{% extends "base.html" %}
{% block content %}
    <h1>{{ title }}</h1>
    {% if training_requests %}
        <p>Creating session for multiple requests:</p>
        <ul>
            {% for req in training_requests %}
                <li>Request by <strong>{{ req.requester.full_name }}</strong> for skills:
                    {% for skill in req.skills_requested %}
                        <span class="badge bg-info">{{ skill.name }}</span>
                    {% endfor %}
                </li>
            {% endfor %}
        </ul>
    {% elif training_request %}
        <p>Creating session for request by <strong>{{ training_request.requester.full_name }}</strong> for skills:
            {% for skill in training_request.skills_requested %}
                <span class="badge bg-info">{{ skill.name }}</span>
            {% endfor %}
        </p>
    {% endif %}
    <div class="row">
        <div class="col-md-8">
            <form action="{{ action_url }}" method="post" novalidate>
                {{ form.csrf_token }}
                {% if original_request_ids %}
                    {% for req_id in original_request_ids %}
                        <input type="hidden" name="original_request_ids" value="{{ req_id }}">
                    {% endfor %}
                {% endif %}
                {% include 'admin/_training_session_form_fields.html' %}
                <div class="mb-3">
                    {{ form.submit(class="btn btn-primary", id="submit-training-session") }}
                </div>
            </form>
            <div id="skill-coverage-status" class="mt-3"></div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    const skillsCoveredSelect = $('#skills-covered-select');
    const tutorSelect = $('#tutor-select');
    const skillCoverageStatusDiv = $('#skill-coverage-status');
    const submitButton = $('#submit-training-session');

    // Initialize Select2 for skills_covered
    skillsCoveredSelect.select2({
        placeholder: "Select skills",
        allowClear: true
    });

    // Disable tutor select and submit button initially
    tutorSelect.prop('disabled', true);
    submitButton.prop('disabled', true);

    // Function to update the tutor dropdown based on selected skills
    function updateTutorDropdown() {
        const selectedSkillIds = (skillsCoveredSelect.val() || []).map(id => parseInt(id)).filter(id => !isNaN(id));
        const currentSelectedTutorId = tutorSelect.val();

        console.log("Selected Skill IDs for API call:", selectedSkillIds); // Debugging line
        const requestHeaders = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-API-Key': '{{ current_user.api_key }}'
        };
        console.log("Request Headers:", requestHeaders); // Debugging line

        tutorSelect.empty().append($('<option>', {
            value: '',
            text: 'Select a Tutor'
        }));
        tutorSelect.prop('disabled', true); // Disable by default
        submitButton.prop('disabled', true); // Disable submit by default

        if (selectedSkillIds.length === 0) {
            skillCoverageStatusDiv.empty();
            return;
        }

        fetch("{{ url_for('api.skills_skill_tutors') }}", {
            method: 'POST',
            headers: requestHeaders,
            body: JSON.stringify({ skill_ids: selectedSkillIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.tutors && data.tutors.length > 0) {
                data.tutors.forEach(tutor => {
                    tutorSelect.append($('<option>', {
                        value: tutor.id,
                        text: tutor.full_name
                    }));
                });
                tutorSelect.prop('disabled', false); // Enable if tutors are found

                // Try to re-select the previously selected tutor if still qualified
                if (currentSelectedTutorId && data.tutors.some(t => String(t.id) === String(currentSelectedTutorId))) {
                    tutorSelect.val(currentSelectedTutorId);
                    submitButton.prop('disabled', false); // Enable submit if a valid tutor is re-selected
                } else {
                    tutorSelect.val(''); // Clear selection if current tutor is no longer qualified
                    submitButton.prop('disabled', true); // Keep submit disabled if no valid tutor is selected
                }
                skillCoverageStatusDiv.empty(); // Clear any previous status messages
            } else {
                skillCoverageStatusDiv.html('<div class="alert alert-warning">No qualified tutors found for the selected skills.</div>');
                submitButton.prop('disabled', true); // Disable submit if no qualified tutors
            }
        })
        .catch(error => {
            console.error('Error fetching qualified tutors:', error);
            skillCoverageStatusDiv.html('<div class="alert alert-danger">Error fetching qualified tutors.</div>');
            submitButton.prop('disabled', true);
        });
    }

    // Event listeners
    skillsCoveredSelect.on('change', updateTutorDropdown);
    tutorSelect.on('change', function() {
        submitButton.prop('disabled', !$(this).val()); // Enable submit if a tutor is selected
    });

    // Initial call to set up the tutor dropdown based on pre-selected skills (if any)
    updateTutorDropdown();
});
</script>
{% endblock %}
