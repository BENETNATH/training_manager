{% extends "base.html" %}

{% block content %}
    <div class="row mb-4">
        <div class="col-md-8">
            <p><b>{{ user.full_name }} </b>- <a href="mailto:{{ user.email }}">{{ user.email }}</a></p>
            {% if user.team %}
                <p>Équipe : <strong>{{ user.team.name }}</strong></p>
            {% endif %}
        </div>
        <div class="col-md-4 text-end">
            <div class="d-grid gap-2 d-md-flex justify-content-md-end align-items-center">
                <div class="btn-group btn-group-sm" role="group" aria-label="Utility actions">
                    <a href="{{ url_for('dashboard.generate_user_booklet_pdf', user_id=current_user.id) }}" target="_blank" class="btn btn-danger" title="Produire mon Livret PDF">
                        <i class="fas fa-file-pdf me-1"></i> Livret PDF
                    </a>
                    {% if current_user.can('admin_access') %}
                    <a href="{{ url_for('admin.index') }}" class="btn btn-secondary" title="Accès Administration">
                        <i class="fas fa-user-shield me-1"></i> Admin
                    </a>
                    {% endif %}
                </div>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Actions Rapides">
                        <i class="fas fa-plus-circle me-1"></i> Actions
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><button class="dropdown-item action-btn" data-action-url="{{ url_for('dashboard.submit_training_request') }}" data-modal-title="Demander une Formation" id="request-training-btn"><i class="fas fa-chalkboard-teacher fa-fw me-2"></i>Demander Formation</button></li>
                        <li><button class="dropdown-item action-btn" data-action-url="{{ url_for('dashboard.declare_skill_practice') }}" data-modal-title="Déclarer une Pratique" id="declare-practice-btn"><i class="fas fa-running fa-fw me-2"></i>Déclarer Pratique</button></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><button class="dropdown-item action-btn" data-action-url="{{ url_for('dashboard.submit_external_training') }}" data-modal-title="Soumettre une Formation Externe" id="submit-external-training-btn"><i class="fas fa-external-link-alt fa-fw me-2"></i>Formation Externe</button></li>
                        <li><button class="dropdown-item action-btn" data-action-url="{{ url_for('dashboard.submit_continuous_training_attendance') }}" data-modal-title="Déclarer Présence Formation Continue" id="submit-continuous-training-attendance-btn"><i class="fas fa-calendar-check fa-fw me-2"></i>Présence FC</button></li>
                        <li><button class="dropdown-item action-btn" data-action-url="{{ url_for('dashboard.request_continuous_training_event') }}" data-modal-title="Demander un Événement de Formation Continue" id="request-continuous-training-event-btn"><i class="fas fa-calendar-plus fa-fw me-2"></i>Demander Événement FC</button></li>
                        <li><button class="dropdown-item action-btn" data-action-url="{{ url_for('dashboard.propose_skill') }}" data-modal-title="Proposer une Nouvelle Compétence" id="propose-skill-btn"><i class="fas fa-lightbulb fa-fw me-2"></i>Proposer Compétence</button></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <hr>



    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="training-summary-tab" data-bs-toggle="tab" data-bs-target="#training-summary-tab-pane" type="button" role="tab" aria-controls="training-summary-tab-pane" aria-selected="true">Synthèse Formations
                {% if not is_continuous_training_compliant or not is_live_training_ratio_compliant %}
                    <span class="badge bg-danger rounded-pill ms-1"><i class="fas fa-exclamation-triangle"></i></span>
                {% endif %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="competencies-tab" data-bs-toggle="tab" data-bs-target="#competencies-tab-pane" type="button" role="tab" aria-controls="competencies-tab-pane" aria-selected="false">Mes Compétences
                {% if user_skills_needing_recycling_count > 0 %}
                    <span class="badge bg-warning rounded-pill ms-1">{{ user_skills_needing_recycling_count }}</span>
                {% endif %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="training-requests-tab" data-bs-toggle="tab" data-bs-target="#training-requests-tab-pane" type="button" role="tab" aria-controls="training-requests-tab-pane" aria-selected="false">Mes Demandes & Sessions
                {% set total_pending_requests = user_pending_training_requests_count + user_pending_external_trainings_count %}
                {% if total_pending_requests > 0 %}
                    <span class="badge bg-danger rounded-pill ms-1">{{ total_pending_requests }}</span>
                {% endif %}
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="dashboardTabsContent">
        <!-- Synthèse Formations Tab Pane -->
        <div class="tab-pane fade show active" id="training-summary-tab-pane" role="tabpanel" aria-labelledby="training-summary-tab" tabindex="0">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">Synthèse des Formations</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8 mb-4 mb-lg-0">
                            <div style="height: 250px; position: relative;">
                                <canvas id="trainingHistoryChart"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div style="font-size: 0.875rem; line-height: 1.4;">
                                <div class="row">
                                    <div class="col-6">
                                        <h5 class="mt-0 mb-1" style="font-size: 1rem;">Formation Initiale</h5>
                                        {% if initial_regulatory_training %}
                                            <p class="mb-1"><strong>Niveau:</strong> {{ initial_regulatory_training.level.value }}</p>
                                            <p class="mb-1"><strong>Date:</strong> {{ initial_regulatory_training.training_date.strftime('%Y-%m-%d') }}</p>
                                            {% if initial_regulatory_training.attachment_path %}
                                                <p class="mb-1"><strong>Attestation:</strong> <a href="{{ url_for('static', filename=initial_regulatory_training.attachment_path) }}" target="_blank">Voir <i class="fas fa-paperclip fa-xs"></i></a></p>
                                            {% endif %}
                                        {% else %}
                                            <p class="mb-1 text-muted">Aucune enregistrée.</p>
                                        {% endif %}
                                    </div>
                                    <div class="col-6">
                                        <h5 class="mt-0 mb-1" style="font-size: 1rem;">Conformité Continue</h5>
                                        <p class="mb-1"><strong>Heures:</strong> {{ "%.2f"|format(total_continuous_training_hours_6_years) }} / {{ "%.2f"|format(required_continuous_training_hours) }}</p>
                                        <p class="mb-1"><strong>Statut:</strong> 
                                            {% if is_continuous_training_compliant %}<span class="badge bg-success">Conforme</span>{% else %}<span class="badge bg-danger">Non Conforme</span>{% endif %}
                                        </p>
                                    </div>
                                </div>
                                <hr class="my-2">
                                <div class="row">
                                    <div class="col-6">
                                        <h5 class="mt-2 mb-1" style="font-size: 1rem;">Ratio Présentiel</h5>
                                        <p class="mb-1"><strong>Ratio:</strong> {{ "%.2f"|format(live_training_ratio * 100) }}%</p>
                                        <p class="mb-1"><strong>Statut:</strong>
                                            {% if is_live_training_ratio_compliant %}<span class="badge bg-success">Conforme</span>{% else %}<span class="badge bg-warning">Non Conforme</span>{% endif %}
                                        </p>
                                    </div>
                                    <div class="col-6">
                                        <h5 class="mt-2 mb-1" style="font-size: 1rem;">Projection</h5>
                                        <p class="mb-0"><strong>Risque:</strong>
                                            {% if is_at_risk_next_year %}
                                                <span class="badge bg-warning">À risque</span>
                                                <small class="d-block text-muted" style="line-height: 1.2;">Heures / 5 ans</small>
                                            {% else %}
                                                <span class="badge bg-info">Faible</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <h5 class="mt-4">Détail des Formations Continues</h5>
                    <p class="text-muted">Cliquez sur une année dans le graphique pour filtrer le tableau. Cliquez à nouveau pour réinitialiser.</p>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm" id="training-details-table">
                            <thead>
                                <tr>
                                    <th>Année</th>
                                    <th>Titre</th>
                                    <th>Type</th>
                                    <th>Heures</th>
                                    <th>Statut</th>
                                    <th><i class="fas fa-paperclip"></i></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for training in all_continuous_trainings|sort(attribute='event.event_date', reverse=True) %}
                                    <tr class="training-row" data-year="{{ training.event.event_date.year }}">
                                        <td>{{ training.event.event_date.year }}</td>
                                        <td style="cursor: pointer;">
                                            <a class="event-details-link text-primary" data-action-url="{{ url_for('training.show_continuous_training_event_details', event_id=training.event.id) }}">{{ training.event.title }}</a>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'info' if training.event.training_type == ContinuousTrainingType.ONLINE else 'secondary' }}">{{ training.event.training_type.value }}</span>
                                        </td>
                                        <td>
                                            {% if training.status == UserContinuousTrainingStatus.APPROVED %}
                                                {{ "%.2f"|format(training.validated_hours or 0.0) }}
                                            {% else %}
                                                {{ "%.2f"|format(training.event.duration_hours or 0.0) }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if training.status == UserContinuousTrainingStatus.APPROVED else 'warning' }}">{{ training.status.value }}</span>
                                        </td>
                                        <td>
                                            {% if training.attendance_attachment_path %}
                                                <a href="{{ url_for('static', filename=training.attendance_attachment_path) }}" target="_blank" class="btn btn-outline-secondary btn-sm py-0 px-1" title="Voir l'attestation"><i class="fas fa-paperclip"></i></a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mes Compétences Tab Pane -->
        <div class="tab-pane fade" id="competencies-tab-pane" role="tabpanel" aria-labelledby="competencies-tab" tabindex="0">
            <div class="row">
                <!-- Compétences à acquérir -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header bg-primary text-white">Compétences à Acquérir</div>
                        <div class="card-body">
                            {% if required_skills_todo %}
                                <ul class="list-group list-group-flush">
                                    {% for skill in required_skills_todo %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            {{ skill.name }}
                                            <div>
                                                {% if skill.species %}
                                                    {% for species in skill.species %}
                                                        <span class="badge bg-secondary me-1">{{ species.name }}</span>
                                                    {% endfor %}
                                                {% else %}
                                                    <span class="badge bg-secondary me-1">N/A</span>
                                                {% endif %}
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p>Toutes les compétences requises sont acquises !</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Compétences à recycler -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header bg-warning text-white">Compétences à Recycler</div>
                        <div class="card-body">
                            {% set skills_to_recycle = [] %}
                            {% for comp in competencies %}
                                {% if comp.needs_recycling %}
                                    {% set _ = skills_to_recycle.append(comp) %}
                                {% endif %}
                            {% endfor %}

                            {% if skills_to_recycle %}
                                <ul class="list-group list-group-flush">
                                    {% for comp in skills_to_recycle %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            {{ comp.skill.name }}
                                            <div>
                                                {% if comp.skill.species %}
                                                    {% for species in comp.skill.species %}
                                                        <span class="badge bg-secondary me-1">{{ species.name }}</span>
                                                    {% endfor %}
                                                {% else %}
                                                    <span class="badge bg-secondary me-1">N/A</span>
                                                {% endif %}
                                                <span class="badge bg-danger rounded-pill">Échéance: {{ comp.recycling_due_date.strftime('%Y-%m-%d') }}</span>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p>Aucune compétence ne nécessite de recyclage pour le moment.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mes Compétences (Détail) -->
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white">Mes Compétences</div>
                <div class="card-body">
                    {% if competencies %}
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th scope="col">Compétence</th>
                                        <th scope="col">Niveau</th>
                                        <th scope="col">Évalué le</th>
                                        <th scope="col">Évaluateur</th>
                                        <th scope="col">Dernière Pratique</th>
                                        <th scope="col">Échéance Recyclage</th>
                                        <th scope="col">Validité</th>
                                        <th scope="col">Espèces</th>
                                        <th scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for comp in competencies %}
                                        <tr class="{% if comp.needs_recycling %}table-danger{% elif comp.warning_date and datetime.utcnow() > comp.warning_date %}table-warning{% endif %}">
                                            <td>{{ comp.skill.name }}</td>
                                            <td>{{ comp.level }}</td>
                                            <td>{{ comp.evaluation_date.strftime('%Y-%m-%d') }}</td>
                                            <td>
                                                {% if comp.external_evaluator_name %}
                                                    {{ comp.external_evaluator_name }}
                                                {% elif comp.evaluator %}
                                                    {{ comp.evaluator.full_name }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>{{ comp.latest_practice_date.strftime('%Y-%m-%d') if comp.latest_practice_date else 'N/A' }}</td>
                                            <td>
                                                {% if comp.skill.validity_period_months %}
                                                    {{ comp.recycling_due_date.strftime('%Y-%m-%d') }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if comp.skill.validity_period_months %}
                                                    {% if comp.needs_recycling %}
                                                        <span class="badge bg-danger">Expirée</span>
                                                    {% elif comp.warning_date and datetime.utcnow() > comp.warning_date %}
                                                        <span class="badge bg-warning">À Recycler Bientôt</span>
                                                    {% else %}
                                                        <span class="badge bg-success">Valide</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="badge bg-info">Illimitée</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if comp.species %}
                                                    {% for species in comp.species %}
                                                        <span class="badge bg-secondary me-1">{{ species.name }}</span>
                                                    {% endfor %}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('dashboard.generate_certificate', competency_id=comp.id) }}" target="_blank" class="btn btn-sm btn-primary" title="Télécharger l'attestation"><i class="fas fa-download"></i></a>
                                                {% if comp.external_training_id %}
                                                    <a href="{{ url_for('dashboard.show_external_training', training_id=comp.external_training_id) }}" target="_blank" class="btn btn-sm btn-info ms-1" title="Voir Formation Externe"><i class="fas fa-external-link-alt"></i></a>
                                                {% elif comp.training_session_id %}
                                                    <a href="{{ url_for('admin.view_training_session_details', session_id=comp.training_session_id) }}" target="_blank" class="btn btn-sm btn-success ms-1" title="Voir Session de Formation"><i class="fas fa-chalkboard-teacher"></i></a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p>Aucune compétence enregistrée pour le moment.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Mes Demandes & Sessions Tab Pane -->
        <div class="tab-pane fade" id="training-requests-tab-pane" role="tabpanel" aria-labelledby="training-requests-tab" tabindex="0">
            <!-- Demandes de Formation en Cours -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">Mes Demandes de Formation en Cours</div>
                <div class="card-body">
                    {% if pending_training_requests_by_user %}
                        <ul class="list-group list-group-flush">
                            {% for req in pending_training_requests_by_user %}
                                <li class="list-group-item d-flex justify-content-between align-items-center" id="training-request-{{ req.id }}">
                                    Demande du {{ req.request_date.strftime('%Y-%m-%d') }} pour :
                                    <div class="d-flex flex-wrap align-items-center">
                                        {% for skill in req.skills_requested %}
                                            <span class="badge bg-info me-1 mb-1">{{ skill.name }}</span>
                                        {% endfor %}
                                        {% if req.species_requested %}
                                            {% for species in req.species_requested %}
                                                <span class="badge bg-secondary me-1 mb-1">{{ species.name }}</span>
                                            {% endfor %}
                                        {% endif %}
                                        {% if req.status == TrainingRequestStatus.PROPOSED_SKILL %}
                                            <span class="badge bg-warning me-1 mb-1">Compétence Proposée</span>
                                        {% else %}
                                            <span class="badge bg-secondary me-1 mb-1">{{ req.status.value }}</span>
                                        {% endif %}
                                        <button class="btn btn-sm btn-info edit-training-request-btn ms-2" data-action-url="{{ url_for('dashboard.edit_training_request', request_id=req.id) }}" data-modal-title="Modifier la Demande de Formation" title="Modifier la demande">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-training-request-btn ms-2" data-request-id="{{ req.id }}" title="Supprimer la demande">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucune demande de formation en cours.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Mes Formations Externes en Cours -->
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white">Mes Formations Externes en Cours</div>
                <div class="card-body">
                    {% if pending_external_trainings_by_user %}
                        <ul class="list-group list-group-flush">
                            {% for ext_training in pending_external_trainings_by_user %}
                                <li class="list-group-item d-flex justify-content-between align-items-center" id="external-training-{{ ext_training.id }}">
                                    Formation Externe du {{ ext_training.date.strftime('%Y-%m-%d') }} par {{ ext_training.external_trainer_name }}
                                    <div class="d-flex flex-wrap align-items-center">
                                        {% for skill_claim in ext_training.skill_claims %}
                                            <span class="badge bg-info me-1 mb-1">{{ skill_claim.skill.name }} ({{ skill_claim.level }})</span>
                                        {% endfor %}
                                        <span class="badge bg-secondary me-1 mb-1">{{ ext_training.status.value }}</span>
                                        <button class="btn btn-sm btn-info edit-external-training-btn ms-2" data-action-url="{{ url_for('dashboard.edit_external_training', training_id=ext_training.id) }}" data-modal-title="Modifier la Formation Externe" title="Modifier la formation externe">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-external-training-btn ms-2" data-training-id="{{ ext_training.id }}" title="Supprimer la formation externe">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucune formation externe en cours.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Sessions de Formation à Venir -->
            <div class="card shadow mb-4">
                <div class="card-header bg-info text-white">Mes Sessions de Formation à Venir</div>
                <div class="card-body">
                    {% if upcoming_training_sessions_by_user %}
                        <ul class="list-group list-group-flush">
                            {% for session in upcoming_training_sessions_by_user %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ session.title }} ({{ session.start_time.strftime('%Y-%m-%d %H:%M') }})
                                    <span class="badge bg-primary">{{ session.location }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucune session de formation à venir.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Sessions de Formation Réalisées -->
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white">Mes Sessions de Formation Réalisées</div>
                <div class="card-body">
                    {% if completed_training_sessions_by_user %}
                        <ul class="list-group list-group-flush">
                            {% for session in completed_training_sessions_by_user %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ session.title }} ({{ session.end_time.strftime('%Y-%m-%d') }})
                                    <span class="badge bg-success">Terminée</span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucune session de formation réalisée.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

{% endblock %}

    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap @5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Make trainingChartData available globally for dashboard.js
    const trainingChartData = {{ training_chart_data | tojson }};

document.addEventListener('DOMContentLoaded', function () {
    // --- Training History Chart ---
    const ctx = document.getElementById('trainingHistoryChart');
    if (ctx) {
        let currentFilter = null;

        const chart = new Chart(ctx, {
            type: 'bar',
            data: trainingChartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Heures de formation par an'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Heures'
                        }
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const chartElement = elements[0];
                        const year = trainingChartData.labels[chartElement.index];
                        
                        if (currentFilter === year) {
                            currentFilter = null; // Toggle off if clicking the same year
                            filterTableByYear(null);
                        } else {
                            currentFilter = year;
                            filterTableByYear(year);
                        }
                    }
                }
            }
        });

        function filterTableByYear(year) {
            const rows = document.querySelectorAll('#training-details-table .training-row');
            rows.forEach(row => {
                if (year === null || row.dataset.year === year) {
                    row.style.display = ''; // Show row
                } else {
                    row.style.display = 'none'; // Hide row
                }
            });
        }
    }
});
</script>
<style>
    /* Ensure Select2 dropdowns appear above Bootstrap modals */
    .select2-container--open {
        z-index: 1060; /* Bootstrap modal has z-index 1050 */
    }
</style>
    
<script>
            function toggleTutorCheckbox(levelSelectElement) {
                const level = levelSelectElement.value;
                const skillClaimEntry = levelSelectElement.closest('.skill-claim-entry');
                const tutorCheckbox = skillClaimEntry.querySelector('.tutor-checkbox');
                const tutorLabel = skillClaimEntry.querySelector('label[for^="skill_claims-"][for$="-wants_to_be_tutor"]');

                if (level === 'Intermediate' || level === 'Expert') {
                    tutorCheckbox.disabled = false;
                    tutorLabel.classList.remove('text-muted');
                } else {
                    tutorCheckbox.checked = false;
                    tutorCheckbox.disabled = true;
                    tutorLabel.classList.add('text-muted');
                }
            }

$(document).ready(function() {


    // Ensure the submit button is visible again for other modals that need it
    $('.action-btn').on('click', function() {
        if (!$(this).attr('id') || $(this).attr('id') !== 'generate-booklet-btn') {
            $('#submit-action-form-btn').show();
        }
    });
    
    $(document).on('click', '.delete-training-request-btn', function() {
        
        var button = $(this);
                var requestId = String(button.data('request-id'));
                var deleteUrl = "{{ url_for('dashboard.delete_training_request', request_id=0) }}".replace('0', requestId);
                var csrfToken = $('meta[name=csrf-token]').attr('content');

                if (confirm('Êtes-vous sûr de vouloir supprimer cette demande de formation ?')) {
                    fetch(deleteUrl, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            $('#training-request-' + requestId).remove();
                            alert(data.message);
                        } else {
                            alert('Erreur lors de la suppression : ' + (data.message || 'Erreur inconnue.'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Une erreur réseau est survenue.');
                    });
                }
            });

    // Handle edit training request button click
    $(document).on('click', '.edit-training-request-btn', function() {
        var button = $(this);
        var actionUrl = button.data('action-url');
        var modalTitle = button.data('modal-title');

        currentFormActionUrl = actionUrl; // Store for form submission
        $('#action-modal-label').text(modalTitle);

        fetch(actionUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            $('#action-modal .modal-body').html(
                `<form id="modal-action-form" action="${actionUrl}" method="post" novalidate enctype="multipart/form-data">${html}</form>`
            );

            // Re-initialize Select2 for species and skills in the modal
            $('#species').select2({
                placeholder: "Select a species",
                allowClear: true,
                dropdownParent: $('#action-modal'),
                width: '100%'
            });
            $('#skills_requested').select2({
                placeholder: "Select skills",
                allowClear: true,
                dropdownParent: $('#action-modal'),
                width: '100%'
            });

            // Trigger change on species to load skills if a species is pre-selected
            if ($('#species').val()) {
                $('#species').trigger('change');
            }

            window.actionModal.show();
        })
        .catch(error => {
            console.error('Error loading edit form:', error);
            alert('Erreur lors du chargement du formulaire de modification.');
        });
    });

    // Handle delete external training button click
    $(document).on('click', '.delete-external-training-btn', function() {
        var button = $(this);
        var trainingId = String(button.data('training-id'));
        var deleteUrl = "{{ url_for('dashboard.delete_external_training', training_id=0) }}".replace('0', trainingId);
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        if (confirm('Êtes-vous sûr de vouloir supprimer cette formation externe ?')) {
            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#external-training-' + trainingId).remove();
                    alert(data.message);
                } else {
                    alert('Erreur lors de la suppression : ' + (data.message || 'Erreur inconnue.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur réseau est survenue.');
            });
        }
    });

    // Handle edit external training button click
    $(document).on('click', '.edit-external-training-btn', function() {
        var button = $(this);
        var actionUrl = button.data('action-url');
        var modalTitle = button.data('modal-title');

        currentFormActionUrl = actionUrl; // Store for form submission
        $('#action-modal-label').text(modalTitle);

        fetch(actionUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            $('#action-modal .modal-body').html(
                `<form id="modal-action-form" action="${actionUrl}" method="post" novalidate enctype="multipart/form-data">${html}</form>`
            );

            // Re-initialize Select2 for skills and species in the modal
            // This part needs to be adapted for the nested form fields of ExternalTrainingForm
            // The ExternalTrainingForm uses FieldList(FormField(ExternalTrainingSkillClaimForm))
            // So, we need to initialize Select2 for each skill claim entry

            // Parse initial data for Select2 options
            const allSkills = JSON.parse(document.getElementById('all-skills-data').value);
            const allSpecies = JSON.parse(document.getElementById('all-species-data').value);

            function initializeSelect2ForExternalTrainingEntry(entry) {
                const $modalBody = $('#action-modal .modal-body');

                $(entry).find('select').each(function () {
                    const $sel = $(this);
                    const placeholder = $sel.attr('placeholder') || '';

                    const opts = {
                        placeholder: placeholder,
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $modalBody
                    };

                    if (!$sel.hasClass('level-select')) {
                        opts.minimumResultsForSearch = 0;
                    }

                    if ($sel.attr('id').includes('-skill')) {
                        opts.data = allSkills.map(s => ({ id: s.id, text: s.name }));
                    } else if ($sel.attr('id').includes('-species_claimed')) {
                        opts.data = allSpecies.map(s => ({ id: s.id, text: s.name }));
                    }

                    $sel.select2(opts);

                    if ($sel.hasClass('level-select')) {
                        $sel.on('change', function () {
                            toggleTutorCheckbox(this);
                        });
                        toggleTutorCheckbox($sel[0]);
                    }
                });
            }

            // Initial setup for existing form entries
            document.querySelectorAll('#action-modal .skill-claim-entry').forEach(entry => {
                initializeSelect2ForExternalTrainingEntry(entry);
                const levelSelect = entry.querySelector('.level-select');
                if (levelSelect) { // Check if levelSelect exists
                    levelSelect.addEventListener('change', () => toggleTutorCheckbox(levelSelect));
                    toggleTutorCheckbox(levelSelect);
                }
            });

            window.actionModal.show();
        })
        .catch(error => {
            console.error('Error loading edit external training form:', error);
            alert('Erreur lors du chargement du formulaire de modification de formation externe.');
        });
    });





    // Handle event details link click
    $(document).on('click', '.event-details-link', function(e) {
        e.preventDefault();
        var url = $(this).data('action-url');
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => {
                // Check if the modal already exists, if so, remove it to ensure a fresh one
                if ($('#eventDetailsModal').length) {
                    $('#eventDetailsModal').remove();
                }

                // Dynamically create the modal structure
                var modalHtml = `
                    <div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="eventDetailsModalLabel">Détails de l'Événement</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    ${html}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                $('body').append(modalHtml);

                // Initialize and show the modal
                var eventDetailsModal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
                eventDetailsModal.show();

                // Clean up the modal from the DOM after it's hidden
                $('#eventDetailsModal').on('hidden.bs.modal', function () {
                    $(this).remove();
                });
            })
            .catch(error => { console.error('Error loading event details:', error); alert("Erreur lors du chargement des détails de l'événement."); });
    });

    var currentFormActionUrl = '';
    var activeElement = null; // Variable to store the element that opened the modal

    $(document).on('click', '.action-btn', function() {
        var button = $(this);
        var actionUrl = button.data('action-url');
        var modalTitle = button.data('modal-title');
        
        // Special handling for PDF generation and API Key generation (no modal needed)
        if (button.attr('id') === 'generate-booklet-btn') {
            window.open(actionUrl, '_blank');
            return;
        }
        
        // For forms that need to be loaded into the modal
        currentFormActionUrl = actionUrl; // Store for form submission
        $('#action-modal-label').text(modalTitle);

        fetch(actionUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            if (actionUrl === "{{ url_for('dashboard.declare_skill_practice') }}") {
                $('#action-modal .modal-body').html(html);
                $('#modal-action-form').attr('action', actionUrl);
            } else {
                $('#action-modal .modal-body').html(
                    `<form id="modal-action-form" action="${actionUrl}" method="post" novalidate enctype="multipart/form-data">${html}</form>`
                );
            }

            if (actionUrl.includes('request')) {
                $('#species').select2({
                    placeholder: "Select a species",
                    allowClear: true,
                    dropdownParent: $('#action-modal'),
                    width: '100%'
                });
                $('#skills_requested').select2({
                    placeholder: "Select skills",
                    allowClear: true,
                    dropdownParent: $('#action-modal'),
                    width: '100%'
                });

                $('#species').on('change', function() {
                    var speciesId = $(this).val();
                    var skillsSelect = $('#skills_requested');
                    
                    skillsSelect.empty();

                    if (speciesId && speciesId !== "") {
                        fetch(`/api/species/${speciesId}/skills`, {
                            headers: {
                                'X-Requested-with': 'XMLHttpRequest'
                            }
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            data.forEach(skill => {
                                var option = new Option(skill.name, skill.id, false, false);
                                skillsSelect.append(option);
                            });
                            skillsSelect.trigger('change');
                        })
                        .catch(error => {
                            console.error('Error fetching skills:', error);
                        });
                    } else {
                        skillsSelect.trigger('change');
                    }
                });
            }
            // --- END of logic for training request form ---

            // --- START of logic for submit external training form ---
            if (actionUrl === "{{ url_for('dashboard.submit_external_training') }}") {
                const skillClaimsContainer = document.getElementById('skill-claims-container');
                const addSkillClaimButton = document.getElementById('add-skill-claim');
                let skillClaimCount = skillClaimsContainer.children.length;

                // Parse initial data
                const allSkills = JSON.parse(document.getElementById('all-skills-data').value);
                const allSpecies = JSON.parse(document.getElementById('all-species-data').value);
                const levelChoices = [
                    { value: 'Novice', label: 'Novice' },
                    { value: 'Intermediate', label: 'Intermediate' },
                    { value: 'Expert', label: 'Expert' }
                ];

                function generateOptions(data) {
                    return data.map(item => `<option value="${item.value}">${item.label}</option>`).join('');
                }

                function initializeSelect2ForEntry(entry) {
                    const $modalBody = $('#action-modal .modal-body');

                    $(entry).find('select').each(function () {
                        const $sel = $(this);
                        const placeholder = $sel.attr('placeholder') || '';

                        const opts = {
                            placeholder: placeholder,
                            allowClear: true,
                            width: '100%',
                            dropdownParent: $modalBody
                        };

                        if (!$sel.hasClass('level-select')) {
                            opts.minimumResultsForSearch = 0;
                        }

                        if ($sel.attr('id').includes('-skill')) {
                            opts.data = allSkills.map(s => ({ id: s.id, text: s.name }));
                        } else if ($sel.attr('id').includes('-species_claimed')) {
                            opts.data = allSpecies.map(s => ({ id: s.id, text: s.name }));
                        }

                        $sel.select2(opts);

                        if ($sel.hasClass('level-select')) {
                            $sel.on('change', function () {
                                toggleTutorCheckbox(this);
                            });
                            toggleTutorCheckbox($sel[0]);
                        }
                    });
                }

                function toggleTutorCheckbox(levelSelectElement) {
                    const level = levelSelectElement.value;
                    const skillClaimEntry = levelSelectElement.closest('.skill-claim-entry');
                    const tutorCheckbox = skillClaimEntry.querySelector('.tutor-checkbox');
                    const tutorLabel = skillClaimEntry.querySelector('label[for^="skill_claims-"][for$="-wants_to_be_tutor"]');

                    if (level === 'Intermediate' || level === 'Expert') {
                        tutorCheckbox.disabled = false;
                        tutorLabel.classList.remove('text-muted');
                    } else {
                        tutorCheckbox.checked = false;
                        tutorCheckbox.disabled = true;
                        tutorLabel.classList.add('text-muted');
                    }
                }

                function reindexSkillClaims() {
                    Array.from(skillClaimsContainer.children).forEach((entry, index) => {
                        entry.querySelector('.skill-claim-number').textContent = index + 1;
                        entry.querySelectorAll('[name^="skill_claims-"], [id^="skill_claims-"], [for^="skill_claims-"]').forEach(element => {
                            const nameAttr = element.getAttribute('name');
                            const idAttr = element.getAttribute('id');
                            const forAttr = element.getAttribute('for');
                            if (nameAttr) element.setAttribute('name', nameAttr.replace(/skill_claims-\d+/, `skill_claims-${index}`));
                            if (idAttr) element.setAttribute('id', idAttr.replace(/skill_claims-\d+/, `skill_claims-${index}`));
                            if (forAttr) element.setAttribute('for', forAttr.replace(/skill_claims-\d+/, `skill_claims-${index}`));
                        });
                    });
                }

                function updateRemoveButtons() {
                    const removeButtons = skillClaimsContainer.querySelectorAll('.remove-skill-claim');
                    const minEntries = 1; // Default to 1, as form object is not available here
                    const disable = skillClaimsContainer.children.length <= minEntries;
                    removeButtons.forEach(button => button.disabled = disable);
                }

                // Event listener for adding a new skill claim entry
                addSkillClaimButton.addEventListener('click', function() {
                    const index = skillClaimCount;
                    const newEntry = document.createElement('div');
                    newEntry.className = 'card mb-2 p-2 skill-claim-entry';
                    newEntry.innerHTML = `
                        <div class="card-header d-flex justify-content-between align-items-center p-1 bg-light">
                            <h6 class="mb-0">Skill Claim #${index + 1}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-skill-claim">Remove</button>
                        </div>
                        <div class="card-body p-2">
                            <div class="row g-2">
                                <div class="col-12">
                                    <select class="form-control form-control-sm" id="skill_claims-${index}-skill" name="skill_claims-${index}-skill" required placeholder="Select Skill">
                                        ${generateOptions(allSkills.map(s => ({value: s.id, label: s.name})))}
                                    </select>
                                </div>
                                <div class="col-md-3 mt-2">
                                    <select class="form-control form-control-sm species-select" id="skill_claims-${index}-species_claimed" name="skill_claims-${index}-species_claimed" multiple="multiple" placeholder="Select Species">
                                        ${generateOptions(allSpecies.map(s => ({value: s.id, label: s.name})))}</select>
                                </div>
                                <div class="col-md-3 mt-2">
                                    <select class="form-control form-control-sm level-select" id="skill_claims-${index}-level" name="skill_claims-${index}-level" required placeholder="Level">
                                        ${generateOptions(levelChoices)}</select>
                                </div>
                                <div class="col-md-3 mt-2">
                                    <label class="form-label visually-hidden" for="skill_claims-${index}-practice_date">Date of Latest Practice</label>
                                    <input type="datetime-local" class="form-control form-control-sm" id="skill_claims-${index}-practice_date" name="skill_claims-${index}-practice_date" placeholder="Last Practice Date">
                                </div>
                                <div class="col-md-3 mt-2 d-flex align-items-end">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input tutor-checkbox" id="skill_claims-${index}-wants_to_be_tutor" name="skill_claims-${index}-wants_to_be_tutor" type="checkbox" value="y">
                                        <label class="form-check-label" for="skill_claims-${index}-wants_to_be_tutor">Tutor</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    skillClaimsContainer.appendChild(newEntry);
                    skillClaimCount++;
                    updateRemoveButtons();
                    initializeSelect2ForEntry(newEntry);
                    const newLevelSelect = newEntry.querySelector('.level-select');
                    newLevelSelect.addEventListener('change', () => toggleTutorCheckbox(newLevelSelect));
                    toggleTutorCheckbox(newLevelSelect);
                });

                // Event listener for removing a skill claim entry (using event delegation)
                skillClaimsContainer.addEventListener('click', function(event) {
                    if (event.target.classList.contains('remove-skill-claim')) {
                        const minEntries = 1;
                        if (skillClaimsContainer.children.length > minEntries) {
                            event.target.closest('.skill-claim-entry').remove();
                            skillClaimCount--;
                            reindexSkillClaims();
                            updateRemoveButtons();
                        } else {
                            alert('You must claim at least one skill.');
                        }
                    }
                });

                // Initial setup for existing form entries
                document.querySelectorAll('.skill-claim-entry').forEach(entry => {
                    initializeSelect2ForEntry(entry);
                    const levelSelect = entry.querySelector('.level-select');
                    if (levelSelect) { // Check if levelSelect exists
                        levelSelect.addEventListener('change', () => toggleTutorCheckbox(levelSelect));
                        toggleTutorCheckbox(levelSelect);
                    }
                });

                updateRemoveButtons();
            }
            // --- END of logic for submit external training form ---

            window.actionModal.show();
        })
        .catch(error => {
            console.error('Error loading form:', error);
            alert('Erreur lors du chargement du formulaire.');
        });
    });

        // Override the default form submission for this modal

    $(document).on('click', '#submit-action-form-btn', function() {
        $('#modal-action-form').submit();
    });

    $('#action-modal').on('submit', '#modal-action-form', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var csrfToken = $('meta[name=csrf-token]').attr('content');
        var requestBody;
        var headers = {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
        };

        if (url === "{{ url_for('dashboard.declare_skill_practice') }}") {
            var competenciesData = [];
            $('#competencies-container .competency-entry').each(function() {
                var competencyId = $(this).data('competency-id');
                var level = $(this).find('select[name^="level-"]').val();
                var practiceDate = $(this).find('input[name^="practice_date-"]').val();
                var wantsToBeTutor = $(this).find('input[name^="tutor-"]').is(':checked');

                competenciesData.push({
                    competency_id: competencyId,
                    level: level,
                    practice_date: practiceDate,
                    wants_to_be_tutor: wantsToBeTutor
                });
            });
            requestBody = JSON.stringify(competenciesData);
            headers['Content-Type'] = 'application/json';
        } else {
            requestBody = new FormData(this);
        }

        fetch(url, {
            method: 'POST',
            body: requestBody,
            headers: headers
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || 'Action effectuée avec succès !');
                window.actionModal.hide();
                location.reload(); // Reload page to reflect changes
            } else {
                // Handle form errors (e.g., re-render form with errors)
                if (data.form_html) {
                    // For declare_skill_practice, the form_html might contain the entire modal body again
                    // We need to ensure only the form content is re-rendered
                    if (url === "{{ url_for('dashboard.declare_skill_practice') }}") {
                        // Assuming the returned form_html is just the inner content of the modal-body
                        form.parent().html(data.form_html); // Replace the parent div's content
                    } else {
                        form.html(data.form_html); // Re-render form with errors
                    }
                } else {
                    alert(data.message || "Erreur lors de l'action.");
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur réseau est survenue.');
        });
    });

    // Event listener for the new Generate API Key button (removed from dashboard, kept for reference if needed elsewhere)
    /*
    $('#generate-api-key-btn').on('click', function() {
        var button = $(this);
        var actionUrl = "{{ url_for('dashboard.regenerate_api_key') }}"; // Directly use the URL

        if (confirm('Voulez-vous vraiment générer une nouvelle clé API ? L'ancienne sera invalidée et la nouvelle ne sera affichée qu'une seule fois.')) {
            fetch(actionUrl, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Nouvelle clé API générée avec succès ! Veuillez la noter : ' + data.api_key);
                    // Update the displayed API key
                    $('#api-key-display').val(data.api_key);
                } else {
                    alert('Erreur lors de la génération de la clé API.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur réseau est survenue.');
            });
        }
    });
    */
});
</script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_management.js') }}"></script>
<script src="{{ url_for('static', filename='js/skill_management.js') }}"></script>
<script src="{{ url_for('static', filename='js/team_management.js') }}"></script>
{% endblock %}
